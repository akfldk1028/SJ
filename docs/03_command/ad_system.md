# ê´‘ê³  ì‹œìŠ¤í…œ (Ad System) - DK ë‹´ë‹¹

> ìµœì¢… ì—…ë°ì´íŠ¸: 2026-01-31

---

## 1. í† í° í• ë‹¹ í˜„í™©

### Supabase (`user_daily_token_usage`)

| í•­ëª© | ê°’ |
|------|------|
| ì¼ì¼ ê¸°ë³¸ í† í° (daily_quota) | **50,000** |
| ì„¸ì…˜ë‹¹ ê¸°ë³¸ í† í° (í´ë¼ì´ì–¸íŠ¸) | **50,000** (`TokenCounter.defaultMaxInputTokens`) |
| ì¶œë ¥ ì•ˆì „ ë§ˆì§„ | **18,000** (`TokenCounter.safetyMargin`) |
| ê´€ë¦¬ì í† í° í•œë„ | 1,000,000,000 (ë¬´ì œí•œ) |
| ì¼ì¼ í• ë‹¹ëŸ‰ ì´ˆê³¼ ìœ ì € ë¹„ìœ¨ | ì•½ 5% (285ê±´ ì¤‘ 15ê±´) |

### ìºì‹± í˜„í™© (GPT-5.2 ë¹„ìš© í†µì œ)

| ë¶„ì„ íƒ€ì… | í”„ë¡œí•„ë‹¹ í˜¸ì¶œ | ë§Œë£Œ | ê±´ë‹¹ ë¹„ìš© | ì´ ë¹„ìš© |
|----------|-------------|------|----------|---------|
| `saju_base` (í‰ìƒìš´ì„¸) | **1.0íšŒ** | ì˜êµ¬ | $0.08 | $4.19 |
| `yearly_fortune_2026` | **1.0íšŒ** | 2026-12-31 | $0.019 | $3.17 |
| `yearly_fortune_2025` | **1.0íšŒ** | ì˜êµ¬ | $0.018 | $1.52 |
| `monthly_fortune` | **1.0íšŒ** | ì›”ë§ | $0.018 | $2.93 |
| `daily_fortune` | **1.0íšŒ** | 24ì‹œê°„ | $0.004 | $1.40 |

> ìºì‹± ì •ìƒ ì‘ë™ ì¤‘. ê¸°ì¡´ ìœ ì € ì¶”ê°€ API ë¹„ìš© ê±°ì˜ $0.

---

## 2. ê´‘ê³  íƒ€ì…ë³„ êµ¬ì¡°

### íŠ¸ë¦¬ê±° â†’ ê´‘ê³  íƒ€ì… ë§¤í•‘

| íŠ¸ë¦¬ê±° | ì¡°ê±´ | ê´‘ê³  íƒ€ì… | ë³´ìƒ í† í° | í† í° ì§€ê¸‰ ì¡°ê±´ | ìŠ¤í‚µ |
|--------|------|----------|----------|--------------|------|
| `tokenDepleted` | í† í° 100% ì†Œì§„ | **ë³´ìƒí˜• ì˜ìƒ** | **10,000** | ì˜ìƒ ì‹œì²­ ì™„ë£Œ | ë¶ˆê°€ |
| `tokenNearLimit` | í† í° 80%+ | **ë³´ìƒí˜• ì˜ìƒ** | **5,000** | ì˜ìƒ ì‹œì²­ ì™„ë£Œ | ê°€ëŠ¥ |
| `intervalAd` | 5ë²ˆì§¸ ë©”ì‹œì§€ë§ˆë‹¤ | **ë„¤ì´í‹°ë¸Œ** | **2,000** | **ê´‘ê³  í´ë¦­** | ê°€ëŠ¥ |

### ìœ ì € í™”ë©´ íë¦„

**ë³´ìƒí˜• ê´‘ê³  (tokenDepleted / tokenNearLimit)**
```
AI: "ëŒ€í™”ê°€ ì¦ê±°ì› ì–´ìš”! ê´‘ê³ ë¥¼ ë³´ì‹œë©´ ë” ëŒ€í™”í•  ìˆ˜ ìˆì–´ìš”."
[ğŸ ê´‘ê³  ì‹œì²­ í›„ ëŒ€í™”ë¥¼ ê³„ì†í•  ìˆ˜ ìˆì–´ìš”. +5000]  [ê±´ë„ˆë›°ê¸°*]
  â†’ CTA í´ë¦­ â†’ ì „ì²´í™”ë©´ ì˜ìƒ â†’ ì‹œì²­ ì™„ë£Œ â†’ í† í° ì§€ê¸‰ â†’ ëŒ€í™” ì¬ê°œ
  (* tokenDepletedëŠ” ê±´ë„ˆë›°ê¸° ì—†ìŒ)
```

**ë„¤ì´í‹°ë¸Œ ê´‘ê³  (intervalAd)**
```
AI: "ì°¸, ì¶”ì²œí•´ë“œë¦¬ê³  ì‹¶ì€ ê²Œ ìˆì–´ìš”.
     ê´‘ê³ ë¥¼ í´ë¦­í•˜ë©´ AIì™€ ë” ëŒ€í™”í•  ìˆ˜ ìˆì–´ìš”!"
                                        [ê±´ë„ˆë›°ê¸°]
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     [ë„¤ì´í‹°ë¸Œ ê´‘ê³ ]        â”‚  â† ì—¬ê¸°ë¥¼ í´ë¦­í•´ì•¼ í† í°!
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†’ ê´‘ê³  í´ë¦­ â†’ í† í° ì§€ê¸‰ â†’ [ëŒ€í™” ì¬ê°œ] ë²„íŠ¼ í‘œì‹œ
  â†’ ê±´ë„ˆë›°ê¸° â†’ í† í° ì—†ì´ ëŒ€í™” ì¬ê°œ
```

---

## 3. ì¸ë¼ì¸ ê´‘ê³  ì„¤ì • (`AdStrategy`)

| ì„¤ì • | ê°’ | ì„¤ëª… |
|------|------|------|
| `inlineAdMessageInterval` | **5** | 5ë²ˆì§¸ ë©”ì‹œì§€ë§ˆë‹¤ (ì•½ 2.5ë²ˆ ëŒ€í™”) |
| `inlineAdMaxCount` | **10** | ì„¸ì…˜ë‹¹ ìµœëŒ€ 10íšŒ |
| `inlineAdMinMessages` | **5** | ìµœì†Œ 5ê°œ ë©”ì‹œì§€ í›„ ì²« ê´‘ê³  |
| `chatAdType` | nativeMedium | ì±„íŒ… ë²„ë¸” ìŠ¤íƒ€ì¼ |

### interval íƒ€ì´ë° (ìœ ì €+AI ë©”ì‹œì§€ í•©ì‚°)

```
ë©”ì‹œì§€ 1~4: ê´‘ê³  ì—†ìŒ (ëŒ€í™”í•˜ëŠ” ëŠë‚Œ)
ë©”ì‹œì§€ 5:   ì²« ë²ˆì§¸ ê´‘ê³  (2~3ë²ˆ ëŒ€í™” í›„)
ë©”ì‹œì§€ 10:  ë‘ ë²ˆì§¸ ê´‘ê³ 
ë©”ì‹œì§€ 15:  ì„¸ ë²ˆì§¸ ê´‘ê³ 
ë©”ì‹œì§€ 20:  ë„¤ ë²ˆì§¸ ê´‘ê³ 
â†’ ì„¸ì…˜ë‹¹ 3~4íšŒ, ì´ˆë°˜ í­ê²© ì—†ì´ ìì—°ìŠ¤ëŸ¬ìš´ ë¹ˆë„
```

---

## 4. AI ëª¨ë¸ ë¹„ìš© ë¹„êµ

| ëª¨ë¸ | Input/1M | Output/1M | ì„¸ì…˜ë‹¹ ë¹„ìš© | ë¹„ê³  |
|------|---------|----------|-----------|------|
| **Gemini 3.0 Flash** (í˜„ì¬) | $0.50 | $3.00 | ~$0.075 | ì±„íŒ… ì‚¬ìš© |
| Gemini 2.5 Flash | $0.15 | $0.60 | ~$0.017 | 4.4x ì €ë ´ |
| Gemini 2.5 Flash-Lite | $0.10 | $0.40 | ~$0.011 | 6.8x ì €ë ´ |
| **GPT-5.2** | - | - | ~$0.08/ê±´ | **ë¹„ìš©ì˜ 99%** (ì‚¬ì£¼ ë¶„ì„) |

> Gemini 3.0 LiteëŠ” ì¡´ì¬í•˜ì§€ ì•ŠìŒ. LiteëŠ” Gemini 2.5 Flash-Liteë§Œ ìˆìŒ.
> GPT-5.2 ë¹„ìš©ì€ ìºì‹±ìœ¼ë¡œ í†µì œë¨ (í”„ë¡œí•„ë‹¹ 1íšŒë§Œ í˜¸ì¶œ).

---

## 5. ìˆ˜ìµ/ë¹„ìš© ì‹¤ì  (Supabase ì‹¤ë°ì´í„°)

### ë³€ê²½ ì „ (7ì¼ê°„)

| ë‚ ì§œ | ìœ ì €ìˆ˜ | API ë¹„ìš© | Native ë…¸ì¶œ | Native í´ë¦­ | ë³´ìƒí˜• ì™„ë£Œ | ì¶”ì • ìˆ˜ìµ | ì†ìµ |
|------|--------|---------|------------|------------|-----------|----------|------|
| 1/30 | 15 | $2.02 | 144 | 2 | 7 | ~$0.50 | **-$1.52** |
| 1/25 | 32 | $1.81 | 181 | 3 | 2 | ~$0.40 | **-$1.41** |
| 1/23 | 14 | $2.16 | 12 | 0 | 0 | ~$0.01 | **-$2.15** |

### ë³€ê²½ í›„ ì˜ˆìƒ (15ëª…/ì¼ ê¸°ì¤€)

| í•­ëª© | ë³€ê²½ ì „ | ë³€ê²½ í›„ | ë³€í™” |
|------|--------|--------|------|
| Native impression ìˆ˜ìµ | $0.29 | $0.11 | ë¹ˆë„ ì¡°ì • |
| Native click ìˆ˜ìµ | $0.40 | $0.84 | **í´ë¦­ ì¸ì„¼í‹°ë¸Œ íš¨ê³¼** |
| Rewarded (depleted) | $0.21 | $0.08 | ìœ ì§€ |
| Rewarded (nearLimit) | $0.00 | **$0.08** | **ì‹ ê·œ ì¶”ê°€** |
| **ì´ ìˆ˜ìµ** | **~$0.90** | **~$1.11** | **+23%** |
| API ë¹„ìš© | $2.02 | $2.02 | ë™ì¼ |
| **ì†ìµ** | **-$1.12** | **-$0.91** | ì ì ì¶•ì†Œ |

### ì†ìµë¶„ê¸° ì¡°ê±´

- í˜„ì¬ 15ëª… â†’ ì ì ~$0.91/ì¼
- **ìœ ì € 40ëª…+** ë„ë‹¬ ì‹œ ì†ìµë¶„ê¸° ì˜ˆìƒ
- í´ë¦­ë¥ ì´ 8% â†’ 15%ë¡œ ì˜¤ë¥´ë©´ 25ëª…ì—ì„œ ì†ìµë¶„ê¸° ê°€ëŠ¥
- Firebase A/B í…ŒìŠ¤íŠ¸ë¡œ interval ìµœì í™” ê¶Œì¥

---

## 6. 2026-01-31 ë³€ê²½ ì´ë ¥ (ì´ 7ê°œ íŒŒì¼)

### 1ì°¨: ê´‘ê³  í‘œì‹œ í™•ëŒ€

| íŒŒì¼ | ë³€ê²½ |
|------|------|
| `ad_strategy.dart` | `inlineAdMaxCount` 3â†’10, `interval` 3â†’5, `minMessages` 2â†’5 |
| `ad_trigger_service.dart` | `intervalRewardTokens = 2000` ì¶”ê°€ |
| `ad_persona_prompt.dart` | ëª¨ë“  íƒ€ì… CTA ë¬¸êµ¬ ì¶”ê°€, ë³´ìƒí˜•/ë„¤ì´í‹°ë¸Œ êµ¬ë¶„ |
| `saju_chat_shell.dart` | `ConversationalAdWidget` ì „ì²´ íƒ€ì… ë Œë”ë§ |

### 2ì°¨: ìˆ˜ìµ ê·¹ëŒ€í™”

| íŒŒì¼ | ë³€ê²½ |
|------|------|
| `conversational_ad_provider.dart` | impressionâ†’click í† í° ì§€ê¸‰, tokenNearLimitâ†’ë³´ìƒí˜•, í´ë¦­ Supabase ì¶”ì  |
| `conversational_ad_widget.dart` | ë³´ìƒí˜•/ë„¤ì´í‹°ë¸Œ UI ë¶„ë¦¬, CTA ë²„íŠ¼ ë³´ìƒí˜•ë§Œ |
| `ad_persona_prompt.dart` | tokenNearLimit CTA "ëˆ„ë¥´ì‹œë©´"â†’"ë³´ì‹œë©´" (ë³´ìƒí˜• ì „í™˜) |

### ê´‘ê³  íë¦„ (ìµœì¢…)

```
ì‚¬ìš©ì ë©”ì‹œì§€ ì „ì†¡
  â†’ chat_provider.checkAndTrigger()
    â†’ AdTriggerService.checkTrigger(tokenUsage, messageCount)
      â†’ 1ìˆœìœ„: í† í° 100% â†’ tokenDepleted (ë³´ìƒí˜•, í•„ìˆ˜)
      â†’ 2ìˆœìœ„: í† í° 80%+ â†’ tokenNearLimit (ë³´ìƒí˜•, ìŠ¤í‚µ ê°€ëŠ¥)
      â†’ 3ìˆœìœ„: 5ë²ˆì§¸ ë©”ì‹œì§€ â†’ intervalAd (ë„¤ì´í‹°ë¸Œ, ìŠ¤í‚µ ê°€ëŠ¥)
    â†’ _activateAdMode() â†’ í˜ë¥´ì†Œë‚˜ ë¬¸êµ¬ + ê´‘ê³  ë¡œë“œ
    â†’ ConversationalAdWidget ë Œë”ë§
      â†’ ë³´ìƒí˜•: CTA ë²„íŠ¼ â†’ ì˜ìƒ ì‹œì²­ â†’ í† í° ì§€ê¸‰
      â†’ ë„¤ì´í‹°ë¸Œ: ê´‘ê³  í´ë¦­ â†’ í† í° ì§€ê¸‰ / ìŠ¤í‚µ â†’ í† í° ì—†ìŒ
      â†’ ëŒ€í™” ì¬ê°œ
```

---

## 7. í–¥í›„ ìˆ˜ìµ ê°œì„  TODO

- [ ] Firebase A/B í…ŒìŠ¤íŠ¸: interval 4 vs 5 vs 6 ë¹„êµ
- [ ] AdMob eCPM ëª¨ë‹ˆí„°ë§: ë³´ìƒí˜• vs ë„¤ì´í‹°ë¸Œ ì‹¤ì œ ìˆ˜ìµ ë¹„êµ
- [ ] ìœ ì € 30ëª…+ í™•ë³´ í›„ ì†ìµë¶„ê¸° ì¬ê²€ì¦
- [ ] GPT-5.2 â†’ ë” ì €ë ´í•œ ëª¨ë¸ ì „í™˜ ê²€í†  (í’ˆì§ˆ íŠ¸ë ˆì´ë“œì˜¤í”„)
- [ ] Gemini 2.5 Flash-Lite ì „í™˜ í…ŒìŠ¤íŠ¸ (ì±„íŒ… í’ˆì§ˆ ë¹„êµ)
