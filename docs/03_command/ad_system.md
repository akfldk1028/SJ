# ê´‘ê³  ì‹œìŠ¤í…œ (Ad System) - DK ë‹´ë‹¹

> ìµœì¢… ì—…ë°ì´íŠ¸: 2026-02-01

---

## 1. í† í° í• ë‹¹ í˜„í™© (v27)

### Supabase (`user_daily_token_usage`)

| í•­ëª© | ê°’ |
|------|------|
| ì¼ì¼ ê¸°ë³¸ í† í° (daily_quota) | **20,000** |
| ì„¸ì…˜ë‹¹ ê¸°ë³¸ í† í° (í´ë¼ì´ì–¸íŠ¸) | **20,000** (`TokenCounter.defaultMaxInputTokens`) |
| ì¶œë ¥ ì•ˆì „ ë§ˆì§„ | **18,000** (`TokenCounter.safetyMargin`) |
| ê´€ë¦¬ì í† í° í•œë„ | 1,000,000,000 (ë¬´ì œí•œ) |
| ì¿¼í„° ì´ˆê³¼ íŒë‹¨ | `chatting_tokens >= (daily_quota + bonus_tokens + rewarded_tokens_earned)` |

### ìºì‹± í˜„í™© (GPT-5.2 ë¹„ìš© í†µì œ)

| ë¶„ì„ íƒ€ì… | í”„ë¡œí•„ë‹¹ í˜¸ì¶œ | ë§Œë£Œ | ê±´ë‹¹ ë¹„ìš© | ì´ ë¹„ìš© |
|----------|-------------|------|----------|---------|
| `saju_base` (í‰ìƒìš´ì„¸) | **1.0íšŒ** | ì˜êµ¬ | $0.08 | $4.19 |
| `yearly_fortune_2026` | **1.0íšŒ** | 2026-12-31 | $0.019 | $3.17 |
| `yearly_fortune_2025` | **1.0íšŒ** | ì˜êµ¬ | $0.018 | $1.52 |
| `monthly_fortune` | **1.0íšŒ** | ì›”ë§ | $0.018 | $2.93 |
| `daily_fortune` | **1.0íšŒ** | 24ì‹œê°„ | $0.004 | $1.40 |

> ìºì‹± ì •ìƒ ì‘ë™ ì¤‘. ê¸°ì¡´ ìœ ì € ì¶”ê°€ API ë¹„ìš© ê±°ì˜ $0.

---

## 2. ê´‘ê³  íƒ€ì…ë³„ êµ¬ì¡°

### íŠ¸ë¦¬ê±° â†’ ê´‘ê³  íƒ€ì… ë§¤í•‘

| íŠ¸ë¦¬ê±° | ì¡°ê±´ | ê´‘ê³  íƒ€ì… | ë³´ìƒ í† í° | í† í° ì§€ê¸‰ ì¡°ê±´ | ìŠ¤í‚µ |
|--------|------|----------|----------|--------------|------|
| `tokenDepleted` | í† í° 100% ì†Œì§„ | **2ë²„íŠ¼ ì„ íƒ** | ì˜ìƒ **20,000** / ë„¤ì´í‹°ë¸Œ **30,000** | ì˜ìƒ ì‹œì²­ or ê´‘ê³  **í´ë¦­** | ë¶ˆê°€ |
| `tokenNearLimit` | í† í° 80%+ | ~~ë¹„í™œì„±í™”~~ | 0 | `warningRewardTokens=0` | - |
| `intervalAd` | **6ë²ˆì§¸** ë©”ì‹œì§€ë§ˆë‹¤ | **ë„¤ì´í‹°ë¸Œ** | í´ë¦­ ì‹œ **30,000** / ë…¸ì¶œë§Œ **0** | **í´ë¦­ ì‹œì—ë§Œ** | ê°€ëŠ¥ |

### ìœ ì € í™”ë©´ íë¦„

**ë³´ìƒí˜• ê´‘ê³  (tokenDepleted / tokenNearLimit)**
```
AI: "ëŒ€í™”ê°€ ì¦ê±°ì› ì–´ìš”! ê´‘ê³ ë¥¼ ë³´ì‹œë©´ ë” ëŒ€í™”í•  ìˆ˜ ìˆì–´ìš”."
[ğŸ ê´‘ê³  ì‹œì²­ í›„ ëŒ€í™”ë¥¼ ê³„ì†í•  ìˆ˜ ìˆì–´ìš”. +5000]  [ê±´ë„ˆë›°ê¸°*]
  â†’ CTA í´ë¦­ â†’ ì „ì²´í™”ë©´ ì˜ìƒ â†’ ì‹œì²­ ì™„ë£Œ â†’ í† í° ì§€ê¸‰ â†’ ëŒ€í™” ì¬ê°œ
  (* tokenDepletedëŠ” ê±´ë„ˆë›°ê¸° ì—†ìŒ)
```

**ë„¤ì´í‹°ë¸Œ ê´‘ê³  (intervalAd)**
```
AI: "ì°¸, ì¶”ì²œí•´ë“œë¦¬ê³  ì‹¶ì€ ê²Œ ìˆì–´ìš”.
     ê´‘ê³ ë¥¼ í´ë¦­í•˜ë©´ AIì™€ ë” ëŒ€í™”í•  ìˆ˜ ìˆì–´ìš”!"
                                        [ê±´ë„ˆë›°ê¸°]
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     [ë„¤ì´í‹°ë¸Œ ê´‘ê³ ]        â”‚  â† ì—¬ê¸°ë¥¼ í´ë¦­í•´ì•¼ í† í°!
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†’ ê´‘ê³  í´ë¦­ â†’ í† í° ì§€ê¸‰ â†’ [ëŒ€í™” ì¬ê°œ] ë²„íŠ¼ í‘œì‹œ
  â†’ ê±´ë„ˆë›°ê¸° â†’ í† í° ì—†ì´ ëŒ€í™” ì¬ê°œ
```

---

## 3. í˜ì´ì§€ ì „í™˜ ì „ë©´ê´‘ê³  (Interstitial Ad)

> 2026-02-01 ì¶”ê°€

### ì „ë©´ê´‘ê³  ë°°ì¹˜ ìœ„ì¹˜

| í˜ì´ì§€ | íŒŒì¼ | ë¼ìš°íŠ¸ |
|--------|------|--------|
| í‰ìƒìš´ì„¸ | `fortune_category_list.dart` | `/fortune/traditional-saju` |
| 2025ìš´ì„¸ | `fortune_category_list.dart` | `/fortune/yearly-2025` |
| 2026ìš´ì„¸ | `fortune_category_list.dart` | `/fortune/new-year` |
| í•œë‹¬ìš´ì„¸ | `fortune_category_list.dart` | `/fortune/monthly` |
| AI ìƒë‹´ | `main_scaffold.dart` | `/saju/chat` (í•˜ë‹¨ ë„¤ë¹„ íƒ­) |

### êµ¬í˜„ ë°©ì‹

```dart
// fortune_category_list.dart (ìš´ì„¸ ì¹´í…Œê³ ë¦¬ 4ê°œ)
onTap: () async {
  await AdService.instance.showInterstitialAd();
  if (context.mounted) {
    context.push(route);
  }
}

// main_scaffold.dart (AI ìƒë‹´ íƒ­)
case 2:
  await AdService.instance.showInterstitialAd();
  if (context.mounted) {
    context.go(Routes.sajuChat);
  }
```

### ë©”ì¸ í™”ë©´ ë„¤ì´í‹°ë¸Œ ê´‘ê³ 

| ìœ„ì¹˜ | ìƒíƒœ | ë¹„ê³  |
|------|------|------|
| ìš´ì„¸ ì¹´í…Œê³ ë¦¬ ì•„ë˜ (ê´‘ê³  #1) | âœ… ìœ ì§€ | ìŠ¤í¬ë¡¤ ì—†ì´ ë°”ë¡œ ë³´ì„ |
| ë‚´ ì‚¬ì£¼ ì¹´ë“œ ì•„ë˜ (ê´‘ê³  #2) | âŒ ì œê±° | ìŠ¤í¬ë¡¤ í•„ìš”, ì¤‘ë³µ ë…¸ì¶œ |

---

## 4. ì¸ë¼ì¸ ê´‘ê³  ì„¤ì • (`AdStrategy`) - v27

| ì„¤ì • | ê°’ | ì„¤ëª… |
|------|------|------|
| `inlineAdMessageInterval` | **2** | 2ë²ˆì§¸ ë©”ì‹œì§€ë§ˆë‹¤ (ë§¤ ëŒ€í™”) |
| `inlineAdMaxCount` | **9999** | ë¬´ì œí•œ |
| `inlineAdMinMessages` | **2** | 2ë²ˆì§¸ ë©”ì‹œì§€ë¶€í„° ê´‘ê³  ê°€ëŠ¥ |
| `chatAdType` | nativeMedium | ì±„íŒ… ë²„ë¸” ìŠ¤íƒ€ì¼ |

### interval íƒ€ì´ë° (ìœ ì €+AI ë©”ì‹œì§€ í•©ì‚°)

```
ë©”ì‹œì§€ 1~2: ì²« ëŒ€í™”
ë©”ì‹œì§€ 2:   ì²« ë²ˆì§¸ ê´‘ê³  â†’ impression 1,500 í† í° ìë™ ì§€ê¸‰
ë©”ì‹œì§€ 3~4: ë‹¤ìŒ ëŒ€í™”
ë©”ì‹œì§€ 4:   ë‘ ë²ˆì§¸ ê´‘ê³  â†’ impression 1,500 í† í°
...
â†’ ë¬´ì œí•œ ë°˜ë³µ, í• ìˆ˜ë¡ ì´ë“ (impression ìˆ˜ì… > í† í° ë¹„ìš©)
```

### v27 í•µì‹¬ ë³€ê²½: ì¦‰ì‹œ ì„œë²„ ì €ì¥

```
Before (v26): impression â†’ stateë§Œ â†’ "ëŒ€í™” ì¬ê°œ" ë²„íŠ¼ â†’ RPC (ë¯¸í´ë¦­ ì‹œ ìœ ì‹¤!)
After (v27):  impression â†’ state + _saveBonusToServer() ì¦‰ì‹œ â†’ DB ì¦‰ì‹œ ë°˜ì˜
```

---

## 5. AI ëª¨ë¸ ë¹„ìš© ë¹„êµ

| ëª¨ë¸ | Input/1M | Output/1M | ì„¸ì…˜ë‹¹ ë¹„ìš© | ë¹„ê³  |
|------|---------|----------|-----------|------|
| **Gemini 3.0 Flash** (í˜„ì¬) | $0.50 | $3.00 | ~$0.075 | ì±„íŒ… ì‚¬ìš© |
| Gemini 2.5 Flash | $0.15 | $0.60 | ~$0.017 | 4.4x ì €ë ´ |
| Gemini 2.5 Flash-Lite | $0.10 | $0.40 | ~$0.011 | 6.8x ì €ë ´ |
| **GPT-5.2** | - | - | ~$0.08/ê±´ | **ë¹„ìš©ì˜ 99%** (ì‚¬ì£¼ ë¶„ì„) |

> Gemini 3.0 LiteëŠ” ì¡´ì¬í•˜ì§€ ì•ŠìŒ. LiteëŠ” Gemini 2.5 Flash-Liteë§Œ ìˆìŒ.
> GPT-5.2 ë¹„ìš©ì€ ìºì‹±ìœ¼ë¡œ í†µì œë¨ (í”„ë¡œí•„ë‹¹ 1íšŒë§Œ í˜¸ì¶œ).

---

## 6. ìˆ˜ìµ/ë¹„ìš© ì‹¤ì  (Supabase ì‹¤ë°ì´í„°)

### ë³€ê²½ ì „ (7ì¼ê°„)

| ë‚ ì§œ | ìœ ì €ìˆ˜ | API ë¹„ìš© | Native ë…¸ì¶œ | Native í´ë¦­ | ë³´ìƒí˜• ì™„ë£Œ | ì¶”ì • ìˆ˜ìµ | ì†ìµ |
|------|--------|---------|------------|------------|-----------|----------|------|
| 1/30 | 15 | $2.02 | 144 | 2 | 7 | ~$0.50 | **-$1.52** |
| 1/25 | 32 | $1.81 | 181 | 3 | 2 | ~$0.40 | **-$1.41** |
| 1/23 | 14 | $2.16 | 12 | 0 | 0 | ~$0.01 | **-$2.15** |

### ë³€ê²½ í›„ ì˜ˆìƒ (15ëª…/ì¼ ê¸°ì¤€)

| í•­ëª© | ë³€ê²½ ì „ | ë³€ê²½ í›„ | ë³€í™” |
|------|--------|--------|------|
| Native impression ìˆ˜ìµ | $0.29 | $0.11 | ë¹ˆë„ ì¡°ì • |
| Native click ìˆ˜ìµ | $0.40 | $0.84 | **í´ë¦­ ì¸ì„¼í‹°ë¸Œ íš¨ê³¼** |
| Rewarded (depleted) | $0.21 | $0.08 | ìœ ì§€ |
| Rewarded (nearLimit) | $0.00 | **$0.08** | **ì‹ ê·œ ì¶”ê°€** |
| **ì´ ìˆ˜ìµ** | **~$0.90** | **~$1.11** | **+23%** |
| API ë¹„ìš© | $2.02 | $2.02 | ë™ì¼ |
| **ì†ìµ** | **-$1.12** | **-$0.91** | ì ì ì¶•ì†Œ |

### ì†ìµë¶„ê¸° ì¡°ê±´

- í˜„ì¬ 15ëª… â†’ ì ì ~$0.91/ì¼
- **ìœ ì € 40ëª…+** ë„ë‹¬ ì‹œ ì†ìµë¶„ê¸° ì˜ˆìƒ
- í´ë¦­ë¥ ì´ 8% â†’ 15%ë¡œ ì˜¤ë¥´ë©´ 25ëª…ì—ì„œ ì†ìµë¶„ê¸° ê°€ëŠ¥
- Firebase A/B í…ŒìŠ¤íŠ¸ë¡œ interval ìµœì í™” ê¶Œì¥

---

## 7. ë³€ê²½ ì´ë ¥

### 2026-02-01: ê´‘ê³  ì‹œìŠ¤í…œ ëŒ€í­ ê°œí¸

**1. í˜ì´ì§€ ì „í™˜ ì „ë©´ê´‘ê³  ì¶”ê°€**

| íŒŒì¼ | ë³€ê²½ |
|------|------|
| `fortune_category_list.dart` | 4ê°œ ìš´ì„¸ í˜ì´ì§€ ì´ë™ ì‹œ `AdService.showInterstitialAd()` í˜¸ì¶œ |
| `main_scaffold.dart` | AI ìƒë‹´ íƒ­ í´ë¦­ ì‹œ `AdService.showInterstitialAd()` í˜¸ì¶œ |
| `menu_screen.dart` | í•˜ë‹¨ ë„¤ì´í‹°ë¸Œ ê´‘ê³  #2 ì œê±° (ì¤‘ë³µ ë…¸ì¶œ ë°©ì§€) |

**2. ì±„íŒ… ë‚´ ê´‘ê³  ë¹ˆë„ ì¡°ì • (v27 ìµœì¢…)**

| ì„¤ì • | ì›ë˜ | SONNY ì œì•ˆ | DK-CC ìµœì¢… |
|------|------|-----------|-----------|
| `inlineAdMessageInterval` | 5 | 10 | **2** |
| `inlineAdMinMessages` | 5 | 10 | **2** |
| `inlineAdMaxCount` | 10 | 10 | **9999** |
| `interstitialMinInterval` | 60ì´ˆ | 30ì´ˆ | **0ì´ˆ** |

**3. í† í° ë³´ìƒ êµ¬ì¡° (v27 ìµœì¢…)**

| êµ¬ë¶„ | í† í° | ì™•ë³µ ëŒ€í™” | ì„¤ëª… |
|------|------|----------|------|
| ì´ˆê¸° ë¬´ë£Œ | 20,000 | ~3ë²ˆ | ê¸°ë³¸ ì œê³µ (daily_quota) |
| ğŸ¬ ì˜ìƒ ê´‘ê³  | 35,000 | 5ë²ˆ | í† í° ì†Œì§„ ì‹œ ë³´ìƒí˜• ì˜ìƒ |
| ğŸ“‹ ë„¤ì´í‹°ë¸Œ ê´‘ê³  (ì†Œì§„ ì„ íƒ) | 21,000 | 3ë²ˆ | í† í° ì†Œì§„ ì‹œ ë„¤ì´í‹°ë¸Œ ì„ íƒ |
| ğŸ‘ï¸ impression ë³´ìƒ | 1,500 | 0.2ë²ˆ | 2ë©”ì‹œì§€ë§ˆë‹¤ ìë™ |
| ğŸ‘† í´ë¦­ ë³´ë„ˆìŠ¤ | +1,500 | +0.2ë²ˆ | í´ë¦­ ì‹œ ì¶”ê°€ |

**4. í† í° ë¶€ì¡± ì‹œ UI ê°œì„ **

í† í° ì†Œì§„ ì‹œ ì±„íŒ…ì°½ì— 2ê°œ ë²„íŠ¼ ì„ íƒì§€ ì œê³µ:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”® AI: ëŒ€í™”ê°€ ì¦ê±°ì› ì–´ìš”!        â”‚
â”‚    í† í°ì´ ë¶€ì¡±í•´ì„œ ì ì‹œ ì‰¬ì–´ì•¼   â”‚
â”‚    í•  ê²ƒ ê°™ì•„ìš”.                â”‚
â”‚                                 â”‚
â”‚  [ğŸ¬ ì˜ìƒ ë³´ê³  5ë²ˆ ëŒ€í™”] â† ì¶”ì²œ  â”‚
â”‚  [ğŸ“‹ ê´‘ê³  ë³´ê³  3ë²ˆ ëŒ€í™”]        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2026-01-31 ë³€ê²½ ì´ë ¥ (ì´ 7ê°œ íŒŒì¼)

### 1ì°¨: ê´‘ê³  í‘œì‹œ í™•ëŒ€

| íŒŒì¼ | ë³€ê²½ |
|------|------|
| `ad_strategy.dart` | `inlineAdMaxCount` 3â†’10, `interval` 3â†’5, `minMessages` 2â†’5 |
| `ad_trigger_service.dart` | `intervalRewardTokens = 2000` ì¶”ê°€ |
| `ad_persona_prompt.dart` | ëª¨ë“  íƒ€ì… CTA ë¬¸êµ¬ ì¶”ê°€, ë³´ìƒí˜•/ë„¤ì´í‹°ë¸Œ êµ¬ë¶„ |
| `saju_chat_shell.dart` | `ConversationalAdWidget` ì „ì²´ íƒ€ì… ë Œë”ë§ |

### 2ì°¨: ìˆ˜ìµ ê·¹ëŒ€í™”

| íŒŒì¼ | ë³€ê²½ |
|------|------|
| `conversational_ad_provider.dart` | impressionâ†’click í† í° ì§€ê¸‰, tokenNearLimitâ†’ë³´ìƒí˜•, í´ë¦­ Supabase ì¶”ì  |
| `conversational_ad_widget.dart` | ë³´ìƒí˜•/ë„¤ì´í‹°ë¸Œ UI ë¶„ë¦¬, CTA ë²„íŠ¼ ë³´ìƒí˜•ë§Œ |
| `ad_persona_prompt.dart` | tokenNearLimit CTA "ëˆ„ë¥´ì‹œë©´"â†’"ë³´ì‹œë©´" (ë³´ìƒí˜• ì „í™˜) |

### ê´‘ê³  íë¦„ (ìµœì¢…)

```
ì‚¬ìš©ì ë©”ì‹œì§€ ì „ì†¡
  â†’ chat_provider.checkAndTrigger()
    â†’ AdTriggerService.checkTrigger(tokenUsage, messageCount)
      â†’ 1ìˆœìœ„: í† í° 100% â†’ tokenDepleted (ë³´ìƒí˜•, í•„ìˆ˜)
      â†’ 2ìˆœìœ„: í† í° 80%+ â†’ tokenNearLimit (ë³´ìƒí˜•, ìŠ¤í‚µ ê°€ëŠ¥)
      â†’ 3ìˆœìœ„: 5ë²ˆì§¸ ë©”ì‹œì§€ â†’ intervalAd (ë„¤ì´í‹°ë¸Œ, ìŠ¤í‚µ ê°€ëŠ¥)
    â†’ _activateAdMode() â†’ í˜ë¥´ì†Œë‚˜ ë¬¸êµ¬ + ê´‘ê³  ë¡œë“œ
    â†’ ConversationalAdWidget ë Œë”ë§
      â†’ ë³´ìƒí˜•: CTA ë²„íŠ¼ â†’ ì˜ìƒ ì‹œì²­ â†’ í† í° ì§€ê¸‰
      â†’ ë„¤ì´í‹°ë¸Œ: ê´‘ê³  í´ë¦­ â†’ í† í° ì§€ê¸‰ / ìŠ¤í‚µ â†’ í† í° ì—†ìŒ
      â†’ ëŒ€í™” ì¬ê°œ
```

---

## 8. v27 ìˆ˜ì • ìš”ì•½ (2026-02-01)

### ì½”ë“œ ë³€ê²½

| íŒŒì¼ | ë³€ê²½ ë‚´ìš© |
|------|-----------|
| `conversational_ad_provider.dart` | `_saveBonusToServer()` ì¶”ê°€ â†’ impression/click ì¦‰ì‹œ RPC |
| `conversational_ad_widget.dart` | `_handleAdComplete` â†’ `isRewardedAd: true` ê³ ì • (RPC ì¤‘ë³µ ë°©ì§€) |
| `ad_trigger_service.dart` | `depletedRewardTokensVideo`(35,000) / `depletedRewardTokensNative`(21,000) ìƒìˆ˜ ì¶”ê°€ |
| `ad_strategy.dart` | interval=2, maxCount=9999, minMessages=2 |

### ë²„ê·¸ ìˆ˜ì •

| ë²„ê·¸ | ì›ì¸ | ìˆ˜ì • |
|------|------|------|
| `bonus_tokens=0` (86 impressionì¸ë°) | "ëŒ€í™” ì¬ê°œ" ë¯¸í´ë¦­ ì‹œ RPC ë¯¸í˜¸ì¶œ | impression ì‹œ ì¦‰ì‹œ `_saveBonusToServer` |
| `depletedRewardTokensVideo/Native` ë¯¸ì¡´ì¬ | ë¨¸ì§€ëœ ìœ„ì ¯ì´ ì°¸ì¡°í•˜ë‚˜ ìƒìˆ˜ ì—†ìŒ | ad_trigger_service.dartì— ì¶”ê°€ |

## 9. í–¥í›„ TODO

- [ ] `rewarded_tokens_earned` ê°„í—ì  0 ëª¨ë‹ˆí„°ë§ (trackRewarded ë¹„ë™ê¸° íƒ€ì´ë°)
- [ ] integration_test ë¹Œë“œ ì—ëŸ¬ ìˆ˜ì • (í”ŒëŸ¬ê·¸ì¸ ì„¤ì •)
- [ ] AdMob eCPM ëª¨ë‹ˆí„°ë§: ì‹¤ì œ ìˆ˜ìµ í™•ì¸ í›„ interval ì¡°ì •
- [ ] Firebase A/B í…ŒìŠ¤íŠ¸: interval 2 vs 3 ë¹„êµ
