# 사주 챗봇 기능 명세서

> 만톡의 핵심 기능 - Gemini 기반 AI 사주 상담 채팅

---

## 1. 기본 정보

| 항목 | 내용 |
|------|------|
| 기능명 | 사주 챗봇 (AI 사주 상담) |
| 우선순위 | **P0 (필수 - 핵심 기능)** |
| 라우트 | /saju/chat |
| 상태 | 기획 완료 |

---

## 2. 사용자 스토리

1. **사용자**로서, 내 사주를 바탕으로 **AI와 대화하며 상담**받고 싶다
2. **사용자**로서, "올해 이직해도 될까?" 같은 **구체적인 질문**을 하고 싶다
3. **사용자**로서, AI가 제안하는 **추천 질문**을 눌러서 편하게 대화하고 싶다
4. **사용자**로서, 언제든 **사주 요약**을 확인하면서 대화하고 싶다
5. **사용자**로서, 과거 **대화 내용을 이어가며** 상담받고 싶다

---

## 3. 화면 구성

### 3.1 화면 레이아웃
```
┌────────────────────────────────────────────┐
│ [←] 만톡        [프로필 전환 ▼] [⚙️ 설정]   │  ← AppBar
├────────────────────────────────────────────┤
│ ┌────────────────────────────────────────┐ │
│ │ 🔮 사주는 참고용입니다                  │ │  ← 면책 배너
│ └────────────────────────────────────────┘ │
├────────────────────────────────────────────┤
│                                            │
│  ┌──────────────────────────────────────┐  │
│  │ 안녕하세요! 저는 만톡이에요.          │  │  ← AI 인사
│  │ 오늘 어떤 고민이 있으신가요?          │  │
│  └──────────────────────────────────────┘  │
│                                            │
│                    ┌────────────────────┐  │
│                    │ 올해 이직해도      │  │  ← 사용자 메시지
│                    │ 괜찮을까요?        │  │
│                    └────────────────────┘  │
│                                            │
│  ┌──────────────────────────────────────┐  │
│  │ 사주를 보니 올해는 변화의 기운이      │  │  ← AI 응답
│  │ 강하게 들어와 있어요. 다만...         │  │
│  │                                      │  │
│  │ [현재 직장 힘든 점?] [이직 계기?]    │  │  ← 추천 질문
│  └──────────────────────────────────────┘  │
│                                            │
├────────────────────────────────────────────┤
│ [📊 사주 요약]  [메시지 입력...    ] [➤]  │  ← 입력 영역
└────────────────────────────────────────────┘
```

### 3.2 UI 요소

| 요소 | 타입 | 동작 |
|------|------|------|
| 프로필 전환 버튼 | DropdownButton | 등록된 프로필 목록 표시, 선택 시 전환 |
| 면책 배너 | Container | 스크롤해도 상단 고정, 탭하면 상세 안내 |
| 채팅 리스트 | ListView | 메시지 표시, 자동 스크롤 |
| AI 메시지 버블 | Container | 왼쪽 정렬, 추천 질문 칩 포함 |
| 사용자 메시지 버블 | Container | 오른쪽 정렬, 배경색 다름 |
| 추천 질문 칩 | ActionChip | 탭하면 해당 질문 자동 전송 |
| 사주 요약 버튼 | IconButton | BottomSheet로 요약 표시 |
| 메시지 입력 필드 | TextField | 멀티라인, 최대 500자 |
| 전송 버튼 | IconButton | 입력 내용 전송, 비어있으면 비활성화 |

---

## 4. 수락 조건 (Acceptance Criteria)

### 4.1 채팅 기본 기능
- [ ] 앱 시작 시 AI가 먼저 인사 메시지를 보낸다
- [ ] 사용자가 메시지를 입력하고 전송할 수 있다
- [ ] AI 응답이 올 때까지 로딩 인디케이터를 표시한다
- [ ] AI 응답은 타이핑 효과 또는 즉시 표시 (설정 가능)
- [ ] 새 메시지가 오면 자동으로 하단 스크롤

### 4.2 추천 질문
- [ ] AI 응답에 추천 질문이 있으면 칩으로 표시
- [ ] 추천 질문 칩을 탭하면 해당 질문이 자동 전송
- [ ] 추천 질문은 2~4개까지 표시

### 4.3 프로필 전환
- [ ] 현재 활성화된 프로필 이름이 상단에 표시
- [ ] 프로필 전환 시 새 대화 세션 시작 (또는 확인 팝업)
- [ ] 프로필별로 대화 히스토리 분리

### 4.4 사주 요약
- [ ] "사주 요약" 버튼 탭 → BottomSheet로 요약 표시
- [ ] 요약에는 성향, 강점, 약점, 올해 운세 포함
- [ ] 요약 시트에서 "자세히 보기" → 상세 리포트 화면

### 4.5 면책 안내
- [ ] 항상 상단에 "사주는 참고용입니다" 배너 표시
- [ ] 배너 탭 시 상세 면책 안내 다이얼로그

### 4.6 에러 처리
- [ ] 네트워크 오류 시 재시도 버튼 표시
- [ ] AI 응답 실패 시 "다시 시도" 옵션
- [ ] Rate Limit 시 안내 메시지 표시

---

## 5. UI/UX 흐름

### 5.1 기본 대화 흐름
```
화면 진입
    ↓
AI 인사 메시지 표시
"안녕하세요! 저는 만톡이에요. 오늘 어떤 고민이 있으신가요?"
    ↓
사용자 메시지 입력
    ↓
전송 버튼 탭
    ↓
로딩 상태 (AI 응답 대기)
    ↓
AI 응답 표시 + 추천 질문
    ↓
(반복)
```

### 5.2 프로필 전환 흐름
```
프로필 전환 버튼 탭
    ↓
프로필 목록 드롭다운
    ↓
다른 프로필 선택
    ↓
확인 팝업 "대화를 새로 시작할까요?"
    ├─ [네] → 새 세션 시작, AI 인사
    └─ [아니오] → 취소
```

### 5.3 사주 요약 흐름
```
"사주 요약" 버튼 탭
    ↓
BottomSheet 올라옴
    ├─ 성향 요약
    ├─ 강점 / 약점
    ├─ 올해 운세 포커스
    └─ [자세히 보기] 버튼
         ↓
    전체 리포트 화면 이동
```

---

## 6. 예외 처리

| 상황 | 처리 방법 | UI 표시 |
|------|-----------|---------|
| 네트워크 오류 | 재시도 버튼 표시 | "연결 오류. [다시 시도]" |
| AI 응답 지연 (10초+) | 취소 옵션 제공 | "응답이 느려요. [취소]" |
| Rate Limit | 대기 안내 | "요청이 많아요. 잠시 후 다시 시도해주세요" |
| 부적절한 질문 | 안전 응답 | "이 주제는 전문가와 상의해 보세요" |
| 빈 메시지 전송 | 전송 버튼 비활성화 | - |
| 프로필 없음 | 프로필 생성 유도 | "먼저 사주 정보를 입력해주세요" |

---

## 7. 데이터 요구사항 (Supabase)

### 7.1 Supabase 연동
| 방식 | 용도 | 설명 |
|------|------|------|
| Edge Function | saju-chat | 메시지 전송 및 Gemini AI 응답 생성 |
| Direct Query | chat_sessions | 채팅 세션 목록 조회 |
| Direct Query | chat_messages | 특정 세션 메시지 목록 조회 |
| Direct Query | saju_summaries | 사주 요약 조회 |

### 7.2 Edge Function 호출 예시
```dart
// 메시지 전송
final response = await supabase.functions.invoke(
  'saju-chat',
  body: {
    'chatId': null,  // 새 세션이면 null
    'profileId': 'profile-uuid',
    'message': '올해 이직해도 괜찮을까요?',
  },
);

// 응답
{
  "success": true,
  "data": {
    "chatId": "chat-uuid",
    "messageId": "msg-uuid",
    "content": "사주를 보니 올해는 변화의 기운이...",
    "suggestedQuestions": [
      "현재 직장에서 힘든 점은?",
      "이직을 고민하게 된 계기는?"
    ],
    "createdAt": "2025-12-01T12:34:56Z"
  }
}
```

### 7.3 Direct Query 예시
```dart
// 채팅 세션 목록
final sessions = await supabase
    .from('chat_sessions')
    .select()
    .eq('profile_id', profileId)
    .order('last_message_at', ascending: false);

// 채팅 메시지 조회
final messages = await supabase
    .from('chat_messages')
    .select()
    .eq('chat_id', chatId)
    .order('created_at', ascending: true);

// 사주 요약 조회
final summary = await supabase
    .from('saju_summaries')
    .select()
    .eq('profile_id', profileId)
    .single();
```

---

## 8. 상태 관리

### 8.1 ChatState
```dart
class ChatState {
  final String? activeChatId;
  final String activeProfileId;
  final List<ChatMessage> messages;
  final bool isLoading;
  final bool isSending;
  final String? error;
  final SajuSummary? summary;
}
```

### 8.2 이벤트/액션
| 액션 | 설명 |
|------|------|
| initChat | 채팅 화면 진입 시 초기화 |
| sendMessage | 사용자 메시지 전송 |
| receiveMessage | AI 응답 수신 |
| loadHistory | 이전 대화 불러오기 |
| switchProfile | 프로필 전환 |
| loadSummary | 사주 요약 로드 |

---

## 9. 의존성

### 9.1 다른 기능과의 관계
- **선행**: profile (프로필 1개 이상 필요)
- **선행**: saju_chart (만세력 계산 완료)
- **연관**: history (대화 기록 저장)

### 9.2 외부 패키지
- `flutter_chat_ui` 또는 커스텀 채팅 UI
- `flutter_markdown` (AI 응답에 마크다운 지원 시)

---

## 10. 테스트 케이스

| TC ID | 시나리오 | 예상 결과 |
|-------|----------|-----------|
| CHAT-001 | 메시지 전송 | AI 응답 수신 |
| CHAT-002 | 추천 질문 탭 | 해당 질문 자동 전송 |
| CHAT-003 | 프로필 전환 | 새 세션 시작 |
| CHAT-004 | 사주 요약 버튼 | BottomSheet 표시 |
| CHAT-005 | 네트워크 오류 | 재시도 버튼 표시 |
| CHAT-006 | 빈 입력 전송 시도 | 전송 버튼 비활성화 |
| CHAT-007 | 스크롤 상단 → 메시지 수신 | 자동 하단 스크롤 |

---

## 변경 이력

| 날짜 | 버전 | 변경 내용 | 작성자 |
|------|------|-----------|--------|
| 2025-12-01 | 0.1 | 초안 작성 | - |
