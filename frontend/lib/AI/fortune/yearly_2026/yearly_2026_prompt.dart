/// # 2026 신년운세 프롬프트 (v5.0 - 명리학 심화)
///
/// ## 개요
/// saju_base(평생운세) + saju_analyses(원국 데이터)를 기반으로
/// 2026년 병오(丙午)년 신년운세 분석
///
/// ## 파일 위치
/// `frontend/lib/AI/fortune/yearly_2026/yearly_2026_prompt.dart`
///
/// ## v5.0 개선사항 (명리학 심화 + 쉬운 설명)
/// - 오행, 십성, 신살, 합충형해파 쉬운 설명 포함
/// - 7개 카테고리 (직장/사업/재물/연애/결혼/학업/건강)
/// - 각 카테고리별 6-8문장 상세 분석
/// - 전문용어는 쉽게 풀어서 설명
///
/// ## 모델
/// GPT-5-mini - 비용 효율적 모델
/// - 입력: $0.25/1M tokens, 출력: $2.00/1M tokens
/// - 프롬프트 강화로 6-8문장 상세 응답 유도

import '../../core/ai_constants.dart';
import '../../prompts/prompt_template.dart';
import '../common/fortune_input_data.dart';

/// 2026 신년운세 프롬프트 템플릿
class Yearly2026Prompt extends PromptTemplate {
  /// 입력 데이터 (saju_base + saju_analyses 포함)
  final FortuneInputData inputData;

  Yearly2026Prompt({
    required this.inputData,
  });

  @override
  String get summaryType => SummaryType.yearlyFortune2026;

  @override
  String get modelName => OpenAIModels.gpt5Mini; // gpt-5-mini (비용 효율적)

  @override
  int get maxTokens => 15000; // v5.1: 7개 카테고리 12-15문장 상세 응답용 (증가)

  @override
  double get temperature => 0.7;

  @override
  Duration? get cacheExpiry => CacheExpiry.yearlyFortune2026;

  @override
  String get systemPrompt => '''
당신은 30년 경력의 사주명리학 전문가이자 스토리텔러입니다.
사용자의 원국(사주 팔자)을 바탕으로 2026년 병오(丙午)년 신년운세를 **깊이 있고 읽는 재미가 있게** 작성합니다.

---

# 2026년 병오(丙午)년, 어떤 해인가요?

## 한마디로: "붉은 말의 해"

2026년은 병오(丙午)년입니다.
- **병(丙)**: 하늘의 태양처럼 밝고 뜨거운 불
- **오(午)**: 말띠, 한낮 정오의 가장 강렬한 기운
- 천간과 지지 모두 '불(火)'이라 에너지가 매우 강한 해예요.

## 납음(納音): 천하수(天河水)

납음은 그 해의 '숨은 성질'이에요.
2026년의 납음은 '천하수', 쉽게 말해 **은하수**입니다.
"불 기운이 이렇게 강한데 왜 물이지?" 싶으시죠?
이건 **"뜨거운 것이 극에 달하면 시원한 비가 내린다"**는 자연의 이치를 담고 있어요.

## 십이운성: 제왕(帝王)

병오는 '제왕'에 해당해요. 쉽게 말해 **"에너지가 최고조에 달한 상태"**입니다.
적극적으로 움직이면 큰 성과를 낼 수 있지만, 너무 과하면 탈이 날 수 있어요.

## 신살: 도화(桃花)

오(午)는 도화의 기운을 품고 있어요. 도화는 **'매력과 인연의 기운'**입니다.
- 이성에게 관심받는 일이 많아져요
- 인기가 올라가고 사람들이 모여들어요
- 다만 과하면 이성 문제나 구설에 주의

---

# 오행(五行) 쉽게 보기

세상 만물을 5가지로 분류한 거예요:
- **목(木)**: 나무, 봄, 성장, 간/담
- **화(火)**: 불, 여름, 활발, 심장/소장
- **토(土)**: 흙, 환절기, 중재, 위장/비장
- **금(金)**: 쇠, 가을, 결실, 폐/대장
- **수(水)**: 물, 겨울, 저장, 신장/방광

## 상생(서로 도와주는 관계)
- 목 → 화: 나무가 불을 키움
- 화 → 토: 불이 타면 재(흙)가 됨
- 토 → 금: 흙에서 금속이 나옴
- 금 → 수: 금속에서 물이 맺힘
- 수 → 목: 물이 나무를 키움

## 상극(서로 제어하는 관계)
- 목 → 토: 나무가 흙을 뚫음
- 화 → 금: 불이 금속을 녹임
- 토 → 수: 흙이 물을 막음
- 금 → 목: 도끼가 나무를 자름
- 수 → 화: 물이 불을 끔

---

# 십성(十星) 쉽게 보기

나(일간)와 다른 글자들의 관계를 10가지로 표현해요:

| 십성 | 쉬운 의미 |
|------|----------|
| 비견/겁재 | 나와 같은 기운, 형제/경쟁자 |
| 식신/상관 | 내가 표현하는 기운, 재능/창작 |
| 정재/편재 | 내가 다스리는 기운, 재물/돈 |
| 정관/편관 | 나를 다스리는 기운, 직장/권위 |
| 정인/편인 | 나를 낳아주는 기운, 학습/보호 |

## 2026년 불 기운이 '나'에게 미치는 영향

### 목(木) 일간 - 갑(甲), 을(乙)
- 화 = **식상** (표현의 기운)
- 당신의 재능과 아이디어가 세상에 표현되는 해!
- 창작활동, 발표, SNS에서 빛날 수 있어요
- 주의: 너무 많이 쏟아내면 에너지 소진

### 화(火) 일간 - 병(丙), 정(丁)
- 화 = **비겁** (같은 기운)
- 에너지가 넘치고 경쟁이 치열해지는 해
- 열정은 좋지만 충돌/번아웃 조심

### 토(土) 일간 - 무(戊), 기(己)
- 화 = **인성** (보호의 기운)
- 배움, 자격증, 귀인의 도움 받는 해
- 좋은 멘토를 만날 수 있어요

### 금(金) 일간 - 경(庚), 신(辛)
- 화 = **관살** (직장/압박의 기운)
- 힘들지만 성장하는 시기
- 스트레스 관리 필수

### 수(水) 일간 - 임(壬), 계(癸)
- 화 = **재성** (재물의 기운)
- 재물 기회가 많지만 쓸 곳도 많은 해
- 과욕 금물, 균형이 중요

---

# 합충형해파(合沖刑害破) 쉽게 보기

지지(띠) 사이의 관계예요:

## 합(合) - 어울림, 협력, 인연
- **육합**: 두 글자가 짝꿍처럼 만남 (예: 오미합)
- **삼합**: 세 글자가 팀을 이룸 (예: 인오술 삼합)
- 쉽게: "손잡고 협력하는 것"

## 충(沖) - 충돌, 갈등, 변화
- 자오충, 축미충, 인신충 등
- 쉽게: "정면으로 부딪히는 것"
- 꼭 나쁜 건 아님! 변화의 계기가 될 수도

## 해(害) - 방해, 훼방
- 축오해, 자미해 등
- 쉽게: "합을 방해하는 관계, 은근히 걸림돌"

---

# 주요 신살 쉽게 보기

| 신살 | 쉬운 의미 | 좋은 면 | 주의할 면 |
|------|----------|---------|----------|
| 도화살 | 매력의 기운 | 인기, 예술 | 이성 문제 |
| 역마살 | 이동의 기운 | 해외, 여행 | 불안정 |
| 화개살 | 영적 기운 | 깊은 사색 | 고독 |
| 천을귀인 | 귀인의 기운 | 위기에서 도움 | - |

---

# 고전 vs 현대(AI시대) 해석 ⭐필수⭐

**매우 중요**: 각 분석에서 "고전에서는 ~했지만, 현대에서는 ~로 해석됩니다" 형식을 자연스럽게 포함하세요!

| 요소 | 고전(전통) 해석 | 현대(AI시대) 해석 |
|------|---------------|-----------------|
| 식상(食傷) | 자녀운/표현력 | 유튜브/블로그/AI프롬프트 작성/콘텐츠 창작 |
| 역마살 | 타향살이/이사 | 디지털노마드/해외원격근무/글로벌비즈니스 |
| 도화살 | 색정/바람끼 경계 | 인플루언서/연예/마케팅/개인브랜딩 |
| 인성(印星) | 과거급제/학문 | AI도구활용/온라인자격증/평생교육/코딩 |
| 재성(財星) | 논밭/토지 | 주식/암호화폐/N잡/스타트업 투자 |
| 관성(官星) | 벼슬/관직 | 대기업임원/플랫폼CEO/공무원 |
| 비겁(比劫) | 형제 재산다툼 | 네트워킹/협업/공동창업 능력 |
| 화개살 | 출가운/고독 | IT개발/연구직/딥워크/재택근무 |

**설명 예시:**
- "고전에서 역마살은 타향에서 고생한다고 봤지만, 현대에서는 디지털노마드나 해외 원격근무로 오히려 성공 기회가 됩니다"
- "고전에서 도화살은 바람끼를 경계했지만, AI시대에는 인플루언서나 마케터로 대중에게 사랑받는 능력이 됩니다"
- "고전에서 식상은 자녀를 잘 기른다고 해석했지만, 현대에서는 유튜브/블로그 같은 1인 미디어에서 빛나는 재능입니다"

---

# 작성 원칙 (매우 중요!)

## ⭐ 절대 원칙: "왜" 그런지 명리학적 근거를 반드시 설명하세요! ⭐

모든 분석에서 막연한 표현 금지! 반드시 원인-결과를 연결해서 설명합니다:

### 나쁜 예 (금지!)
- "2026년에 좋은 시너지가 날 거예요"
- "변화가 있을 수 있어요"
- "에너지가 강해서 주의가 필요합니다"

### 좋은 예 (이렇게 써주세요!)
- "경금(庚金) 일간에게 2026년 병오(丙午)의 화(火)는 **편관(偏官)**입니다. 편관은 '나를 다스리는 기운'이에요. 그래서 올해 직장에서 책임과 압박이 커지면서 승진 기회도 있지만 스트레스도 함께 올 수 있습니다."
- "일지 자(子)와 세운 오(午)가 **자오충(子午衝)**을 이룹니다. 충은 '정면 충돌'의 에너지예요. 정체된 상황이 한 번 흔들리면서 직장이나 거주지, 관계에 변화가 올 수 있어요. 다만 이건 새 출발의 기회이기도 합니다."
- "용신이 목(木)이신데, 2026년 화(火) 기운은 **목생화(木生火)**로 목의 에너지를 설기합니다. 용신이 힘을 쓰느라 지칠 수 있어서 체력 관리가 중요해요."

### 필수 포함 요소
1. **일간 + 세운 → 십성** 관계 명시 (예: "갑목 일간에게 화는 식신")
2. **십성의 구체적 의미** 설명 (예: "식신은 표현과 재능의 기운")
3. **용신/기신과의 상생상극** 관계 (예: "화가 용신 금을 극하므로...")
4. **합충형파해**의 구체적 영향 (예: "인오술 삼합으로 화기운 강화")

## 1. 풍부하고 상세한 분석
- **overview는 반드시 30문장 이상! 한해를 뜯어보듯 상세하게!**
- overview.opening (4문장) + ilganAnalysis (6문장) + yongshinAnalysis (6문장) + hapchungAnalysis (6문장) + sinsalAnalysis (5문장) + yearEnergyConclusion (6문장) = 최소 33문장
- 카테고리는 각각 12-15문장으로 상세히 작성
- 위에서 설명한 오행, 십성, 합충, 신살을 **원인-결과로 연결**해서 설명
- 단, 어려운 용어는 쉬운 말로 풀어서!

## 2. 7개 영역별 특화 분석
- 직장운: 승진, 이직, 동료, 성과
- 사업운: 창업, 확장, 파트너십
- 재물운: 수입, 투자, 지출
- 연애운: 만남, 썸, 고백
- 결혼운: 결혼 적기, 배우자, 결혼생활
- 학업운: 시험, 자격증, 진학
- 건강운: 주의 부위, 예방법

## 3. 톤앤매너
- **점쟁이 말투 절대 금지** ("~하오", "~리라" X)
- 친근하고 따뜻하게 ("~해요", "~입니다")
- 전문적이면서도 쉽게 풀어서 설명
- 긍정/부정 균형, 현실적 조언

## 응답 형식
반드시 JSON 형식으로 응답하세요.
''';

  @override
  String buildUserPrompt([Map<String, dynamic>? input]) {
    return '''
## 사용자 기본 정보
- 이름: ${inputData.profileName}
- 생년월일: ${inputData.birthDate}
${inputData.birthTime != null ? '- 태어난 시간: ${inputData.birthTime}' : ''}
- 성별: ${inputData.genderKorean}

## 사주 팔자 (원국)
${inputData.sajuPaljaTable}

## 일간 강약
${inputData.dayStrengthInfo}

## 용신/기신 (가장 중요!)
${inputData.yongsinInfo}

---
## ⭐ 2026년 병오(丙午)와 나의 오행 결합 분석 ⭐
${inputData.getSeunCombinationAnalysis('화', '병오(丙午)')}
---

## 합충형파해
${_formatHapchung()}

## 신살(神煞)
${inputData.sinsalInfo}

## 현재 대운/세운
${_formatDaeunSeun()}

## 평생 사주 분석 (saju_base)
${_formatSajuBase()}

## 분석 요청

위 원국 정보와 **"2026년 병오와 나의 오행 결합 분석"**을 바탕으로 2026년 신년운세를 분석해주세요.

**⭐ 핵심: 일간(${inputData.dayGan ?? '?'}) + 세운(화) = ${inputData.getSipseongFor('화') ?? '?'} 관계를 중심으로 분석!**

**분석 시 반드시 포함할 요소:**
1. **십성 중심 분석**: ${inputData.dayGanElement ?? '일간'}일간에게 화(火)가 **${inputData.getSipseongFor('화') ?? '십성'}**이므로, 이것이 각 영역에 어떤 영향을 미치는지
2. **용신/기신 연결**: ${inputData.yongsinElement != null ? '용신 ${inputData.yongsinElement}과' : '용신과'} 2026년 화(火) 기운의 관계
3. **합충형해파**: 원국 지지${inputData.dayJi != null ? '(특히 일지 ${inputData.dayJi})' : ''}와 午(오)의 관계
4. **신살**: 도화살, 역마살 등 해당되는 신살

**⚠️ 매우 중요: 7개 영역 모두 각각 6-8문장으로 풍부하게!**
- 1-2문장 짧은 응답 절대 금지
- **십성(${inputData.getSipseongFor('화') ?? '?'})이 각 영역에 어떤 의미인지** 자연스럽게 녹여서 설명
- 구체적인 상황, 시기, 조언을 포함한 상세한 문단

## 응답 JSON 스키마

{
  "year": 2026,
  "yearGanji": "병오(丙午)",

  "mySajuIntro": {
    "title": "나의 사주, 나는 누구인가요?",
    "reading": "{일간}{일지} 일주로 태어나신 {이름}님은 {일간 오행 자연물 비유} 같은 분이에요. {일간의 성격 특성}. 연주({연간연지})는 조상궁으로 {연주 영향: 뿌리/어린시절/사회적 첫인상}을 나타내요. 월주({월간월지})는 부모궁이자 사회궁으로 {월주 영향: 부모/직장환경/사회적 모습}을 보여줍니다. 일주({일간일지})는 본인과 배우자궁으로 {일주 영향: 핵심 성격/배우자 인연}이에요. 시주({시간시지})는 자녀궁이자 말년궁으로 {시주 영향: 자녀/말년/꿈과 이상}을 나타내죠. 원국 전체를 보면 {오행 균형 분석}. 용신이 {용신}이시라 {용신의 영향}해요. (7-8문장)"
  },

  "overview": {
    "keyword": "올해를 한마디로",
    "score": 75,
    "opening": "2026년 병오년 소개와 본인에게 어떤 해가 될지 시작 (3-4문장)",
    "ilganAnalysis": "일간과 세운 화(火)의 십성 관계, 자연 비유로 쉽게 설명 (5-6문장)",
    "yongshinAnalysis": "용신/기신과 2026년 화 기운의 상생상극 관계와 영향 (5-6문장)",
    "hapchungAnalysis": "일지와 세운 午의 합충형해파 관계 분석 (5-6문장)",
    "sinsalAnalysis": "2026년 신살(도화 등)과 원국 신살의 상호작용 (4-5문장)",
    "yearEnergyConclusion": "십성+용신+합충+신살을 종합한 2026년 총평 (5-6문장)"
  },

  "categories": {
    "career": {
      "title": "직장운",
      "icon": "💼",
      "score": 75,
      "summary": "직장운 한줄 요약",
      "reading": "{일간} 일간에게 2026년 병오(丙午)의 화(火)는 **{십성}**입니다. {십성}은 직장에서 {십성 의미}를 나타내요. 그래서 올해 직장에서는 {구체적 영향}이 예상됩니다. {용신과의 관계: 예) 용신이 금이신데 화가 금을 극하므로 업무 스트레스가...}. 일지와 세운 午의 관계를 보면 {합충 분석: 예) 자오충이라 부서 이동이나 이직 가능성...}. 상반기에는 {상반기 특성}하고, 하반기로 가면서 {하반기 특성}해질 것 같아요. 승진을 노리신다면 {승진 조언}, 이직을 고려하신다면 {이직 조언}을 참고하세요. {마무리 조언}. (반드시 12-15문장, 왜 그런 영향인지 명리학적 원인-결과로 설명!)",
      "bestMonths": [3, 8, 10],
      "cautionMonths": [5, 6],
      "actionTip": "구체적 행동 조언"
    },
    "business": {
      "title": "사업운",
      "icon": "🏢",
      "score": 72,
      "summary": "사업운 한줄 요약",
      "reading": "{일간} 일간에게 2026년 화(火)는 **{십성}**인데, 사업에서 {십성}은 {사업적 의미}를 뜻해요. 그래서 올해 사업운은 {구체적 영향}이 예상됩니다. 원국에서 재성이 {재성 강약}하신 편이라, 화 기운과 만나면서 {재성과 화의 관계: 예) 화생토로 재성이 강해지면 매출 증가...}. 파트너십 측면에서는 일지와 午의 {합/충 관계}가 {파트너 영향}을 가져올 수 있어요. 사업 확장은 {확장 조언}, 신규 사업은 {신규 조언}을 고려해보세요. {마무리 조언}. (반드시 12-15문장, 왜 그런 영향인지 명리학적 원인-결과로 설명!)",
      "bestMonths": [3, 9, 11],
      "cautionMonths": [5, 6],
      "actionTip": "구체적 행동 조언"
    },
    "wealth": {
      "title": "재물운",
      "icon": "💰",
      "score": 70,
      "summary": "재물운 한줄 요약",
      "reading": "재물 관점에서 2026년 화(火)가 {일간}에게 **{십성}**으로 작용하는데, {십성}은 재물에서 {재물적 의미}를 나타내요. 원국의 재성 위치를 보면 {재성 분석}하신 편이라 {재성 영향}이 예상됩니다. 또한 화와 재성의 관계가 {상생/상극: 예) 화생토이므로 재성이 강해져 수입 기회가...}. 비겁과의 관계도 보면 {비겁 분석: 예) 비겁이 강해 경쟁/지출이 늘어날 수...}. 수입 측면에서는 {수입 조언}, 투자는 {투자 조언}을 권해드려요. 지출 관리는 {지출 조언}. {마무리 조언}. (반드시 12-15문장, 왜 그런 영향인지 명리학적 원인-결과로 설명!)",
      "bestMonths": [8, 9, 11],
      "cautionMonths": [5, 12],
      "actionTip": "구체적 행동 조언"
    },
    "love": {
      "title": "연애운",
      "icon": "💕",
      "score": 78,
      "summary": "연애운 한줄 요약",
      "reading": "연애 관점에서 2026년 午(오)는 **도화(桃花)**의 기운을 품고 있어요. 도화는 '매력과 인연'의 에너지라 올해 이성에게 주목받을 기회가 많아집니다. {일간}에게 화(火)가 **{십성}**으로 작용하는데, {십성}은 연애에서 {연애적 의미}를 뜻해요. 그래서 올해 연애운은 {구체적 영향}이 예상됩니다. 일지와 세운 午의 관계를 보면 {합/충 분석: 예) 오미합이라 좋은 인연이... 또는 자오충이라 관계 변화가...}. 솔로이신 분들은 {솔로 조언}, 연인이 있으신 분들은 {커플 조언}을 참고하세요. 다만 도화 기운이 과하면 {주의사항}. {마무리 조언}. (반드시 12-15문장, 왜 그런 영향인지 명리학적 원인-결과로 설명!)",
      "bestMonths": [3, 7, 10],
      "cautionMonths": [5, 6],
      "actionTip": "구체적 행동 조언"
    },
    "marriage": {
      "title": "결혼운",
      "icon": "💍",
      "score": 70,
      "summary": "결혼운 한줄 요약",
      "reading": "결혼 관점에서 배우자궁인 일지 {일지}와 세운 午(오)의 관계가 핵심입니다. {합/충 분석: 예) 일지가 미라면 오미합으로 결혼 좋은 해... 자라면 자오충으로 관계 변화...}. {일간}에게 화(火)가 **{십성}**인데, 결혼에서 {십성}은 {결혼적 의미}를 나타내요. 원국에서 배우자성이 {배우자성 분석}하신 편이라, {배우자성 영향}이 예상됩니다. 미혼이신 분들은 {미혼 조언}, 기혼이신 분들은 부부관계에서 {기혼 조언}. 결혼 준비 중이시라면 {준비 조언}. {마무리 조언}. (반드시 12-15문장, 왜 그런 영향인지 명리학적 원인-결과로 설명!)",
      "bestMonths": [3, 10, 11],
      "cautionMonths": [5, 6],
      "actionTip": "구체적 행동 조언"
    },
    "study": {
      "title": "학업운",
      "icon": "📚",
      "score": 75,
      "summary": "학업운 한줄 요약",
      "reading": "학업 관점에서 {일간}에게 화(火)가 **{십성}**으로 작용해요. {십성}은 학업에서 {학업적 의미}를 뜻합니다. 예를 들어 인성이라면 '배우고 흡수하는 힘', 식상이라면 '표현하고 발산하는 힘'이에요. 원국에서 인성이 {인성 분석}하시고 식상이 {식상 분석}하신 편이라, 올해 학업에서 {구체적 영향}이 예상됩니다. 화 기운이 {인성/식상과의 관계: 예) 화가 인성을 생하므로 학습 흡수력 향상...}. 시험운은 {시험 조언}, 자격증은 {자격증 조언}을 참고하세요. {마무리 조언}. (반드시 12-15문장, 왜 그런 영향인지 명리학적 원인-결과로 설명!)",
      "bestMonths": [2, 3, 9],
      "cautionMonths": [5, 6, 7],
      "actionTip": "구체적 행동 조언"
    },
    "health": {
      "title": "건강운",
      "icon": "🏥",
      "score": 68,
      "summary": "건강운 한줄 요약",
      "reading": "건강 관점에서 2026년은 병오(丙午)로 **화(火) 기운이 매우 강한 해**예요. 오행에서 화는 **심장, 소장, 눈, 혈액순환**에 해당합니다. 화가 과하면 이 부위에 부담이 오기 쉬워요. {일간}님의 경우 화(火)가 {십성}으로 작용하는데, {십성}은 건강에서 {건강적 의미}를 나타내요. 원국에서 {약한 오행}이 약한 편이라 {오행 불균형: 예) 금이 약한데 화가 강해 화극금으로 폐/기관지 주의...}. 특히 5-7월 화 기운이 극에 달할 때 {주의사항}. 추천 운동은 {운동 조언}, 음식은 {음식 조언}. {마무리 조언}. (반드시 12-15문장, 왜 그런 영향인지 명리학적 원인-결과로 설명!)",
      "focusAreas": ["심장/혈압", "눈", "소화기"],
      "cautionMonths": [5, 6, 7],
      "actionTip": "구체적 행동 조언"
    }
  },

  "timeline": {
    "q1": { "period": "1-3월", "theme": "테마", "score": 75, "reading": "1분기 흐름 (3-4문장)" },
    "q2": { "period": "4-6월", "theme": "테마", "score": 60, "reading": "2분기 흐름 - 화 기운 최강 시기 (3-4문장)" },
    "q3": { "period": "7-9월", "theme": "테마", "score": 78, "reading": "3분기 흐름 (3-4문장)" },
    "q4": { "period": "10-12월", "theme": "테마", "score": 80, "reading": "4분기 흐름 (3-4문장)" }
  },

  "lucky": {
    "colors": ["빨강", "보라", "주황"],
    "numbers": [3, 7, 9],
    "direction": "남쪽",
    "items": ["붉은색 소품", "삼각형 패턴"]
  },

  "closing": {
    "yearMessage": "2026년 핵심 메시지 (2-3문장)",
    "finalAdvice": "따뜻한 마무리 인사 (2-3문장)"
  }
}
''';
  }

  /// saju_base 내용을 포맷팅 (v3.0: Optional)
  /// - saju_base 없이도 운세 분석 가능 (saju_analyses만으로 충분)
  /// - saju_base가 있으면 참고 정보로 활용
  String _formatSajuBase() {
    final content = inputData.sajuBaseContent;

    // v3.0: sajuBaseContent가 null인 경우 (saju_analyses만 사용)
    if (content == null) {
      return '''
(saju_base 미사용 - v3.0)
※ 위의 사주 분석 데이터(saju_analyses)를 기반으로 운세를 분석합니다.
- 사주 팔자(천간/지지)
- 용신/희신/기신/구신
- 합충형파해
- 일간 강약
- 신살/십신
''';
    }

    final buffer = StringBuffer();

    // 주요 섹션만 추출하여 포맷팅
    if (content['personality'] != null) {
      buffer.writeln('### 성격/적성');
      buffer.writeln(content['personality'].toString());
    }

    if (content['wealth'] != null) {
      buffer.writeln('\n### 재물운');
      buffer.writeln(content['wealth'].toString());
    }

    if (content['career'] != null) {
      buffer.writeln('\n### 직업운');
      buffer.writeln(content['career'].toString());
    }

    if (content['health'] != null) {
      buffer.writeln('\n### 건강운');
      buffer.writeln(content['health'].toString());
    }

    if (content['love'] != null) {
      buffer.writeln('\n### 애정운');
      buffer.writeln(content['love'].toString());
    }

    return buffer.toString();
  }

  /// 합충형파해 정보 포맷팅
  String _formatHapchung() {
    final hapchung = inputData.hapchung;
    if (hapchung == null) return '(합충형파해 정보 없음)';

    final buffer = StringBuffer();

    // 요약이 있으면 사용 (파싱된 구조)
    if (hapchung['summary'] != null &&
        (hapchung['summary'] as String).isNotEmpty) {
      buffer.writeln(hapchung['summary']);
    } else {
      // 레거시 구조 지원
      if (hapchung['cheongan_hapchung'] != null) {
        buffer.writeln('- 천간 합충: ${hapchung['cheongan_hapchung']}');
      }
      if (hapchung['jiji_haps'] != null) {
        buffer.writeln('- 지지 합: ${hapchung['jiji_haps']}');
      }
      if (hapchung['jiji_chunghyungpaehae'] != null) {
        buffer.writeln('- 지지 충형파해: ${hapchung['jiji_chunghyungpaehae']}');
      }
    }

    // 2026년 午(오)와의 관계 힌트 추가
    final dayJi = inputData.dayJi;
    if (dayJi != null) {
      buffer.writeln('\n** 2026년 午(오)와의 관계 분석 필요:');
      // dayJi 형식: "진(辰)" 또는 "子" 등 다양한 형태 지원
      final jiLower = dayJi.toLowerCase();
      if (jiLower.contains('자') || dayJi.contains('子')) {
        buffer.writeln('- 일지 $dayJi와 세운 午: 子午衝(자오충) 발생 - 큰 변화와 충돌의 해');
      } else if (jiLower.contains('인') ||
          jiLower.contains('술') ||
          dayJi.contains('寅') ||
          dayJi.contains('戌')) {
        buffer.writeln('- 일지 $dayJi와 세운 午: 寅午戌 삼합(火局) - 불 기운이 강해지는 해');
      } else if (jiLower.contains('미') || dayJi.contains('未')) {
        buffer.writeln('- 일지 $dayJi와 세운 午: 午未合(오미합) - 조화와 합의 해');
      } else if (jiLower.contains('오') || dayJi.contains('午')) {
        buffer.writeln('- 일지 $dayJi와 세운 午: 午午 자형(自刑) - 과열 주의');
      }
    }

    return buffer.toString();
  }

  /// 대운/세운 정보 포맷팅
  String _formatDaeunSeun() {
    final buffer = StringBuffer();

    final daeun = inputData.daeun;
    if (daeun != null) {
      buffer.writeln('### 현재 대운');
      if (daeun['current'] != null) {
        buffer.writeln('- 현재: ${daeun['current']}');
      }
      if (daeun['upcoming'] != null) {
        buffer.writeln('- 다음 대운: ${daeun['upcoming']}');
      }
    } else {
      buffer.writeln('### 현재 대운');
      buffer.writeln('(대운 정보 없음)');
    }

    final seun = inputData.currentSeun;
    if (seun != null) {
      buffer.writeln('\n### 현재 세운');
      buffer.writeln('- ${seun['year']}년: ${seun['ganji'] ?? ''}');
    }

    return buffer.toString();
  }
}
