# 이번달 운세 프롬프트 설계

## 개요
saju_base(평생운세) + saju_analyses(원국 데이터)를 기반으로 해당 월 운세 분석

## 현재 문제점

| 항목 | 현재 | 개선 |
|------|------|------|
| maxTokens | 2048 (하드코딩) | TokenLimits.monthlyFortuneMaxTokens (4096) |
| 응답 길이 | "2-3문장" | 상세 분석 (각 항목 2-4문장) |
| 용신/기신 | 미사용 | saju_analyses.yongsin으로 월간지 상호작용 |
| 합충형파해 | 미사용 | 월지와 원국 지지의 합충 분석 |
| 주간 분석 | 추상적 | 실제 날짜 기반 구체적 조언 |

## 데이터 소스

### saju_analyses에서 필요한 필드
```json
{
  "day_gan": "戊",           // 일간 - 월간과의 관계
  "day_ji": "午",            // 일지 - 월지와의 합충

  "yongsin": {
    "yongsin": "금(金)",
    "gisin": "화(火)"
  },

  "hapchung": {
    "jiji_hapchung": [...]   // 지지 합충 정보
  },

  "day_strength": {
    "score": 25,
    "type": "신약"
  }
}
```

## 월별 간지 데이터 (2026년 병오년 기준)

| 월 | 간지 | 천간 | 지지 | 오행 |
|----|------|------|------|------|
| 1월 | 경인(庚寅) | 庚(금) | 寅(목) | 금+목 |
| 2월 | 신묘(辛卯) | 辛(금) | 卯(목) | 금+목 |
| 3월 | 임진(壬辰) | 壬(수) | 辰(토) | 수+토 |
| 4월 | 계사(癸巳) | 癸(수) | 巳(화) | 수+화 |
| 5월 | 갑오(甲午) | 甲(목) | 午(화) | 목+화 |
| 6월 | 을미(乙未) | 乙(목) | 未(토) | 목+토 |
| 7월 | 병신(丙申) | 丙(화) | 申(금) | 화+금 |
| 8월 | 정유(丁酉) | 丁(화) | 酉(금) | 화+금 |
| 9월 | 무술(戊戌) | 戊(토) | 戌(토) | 토+토 |
| 10월 | 기해(己亥) | 己(토) | 亥(수) | 토+수 |
| 11월 | 경자(庚子) | 庚(금) | 子(수) | 금+수 |
| 12월 | 신축(辛丑) | 辛(금) | 丑(토) | 금+토 |

## 핵심 분석 로직

### 1. 월간지와 용신/기신 상호작용

```
예: 2026년 5월 갑오(甲午)월, 용신이 금(金)인 경우

분석:
- 월간 甲(목): 금(金)이 목(木)을 극함 → 용신이 월간을 제어
- 월지 午(화): 화(火)가 금(金)을 극함 → 월지가 용신을 억제

결론: 월간은 용신이 통제 가능하나, 월지의 화 기운이 강해
      용신을 소모시킴. 이 달은 에너지 관리가 중요.
점수: 60점 (하반월에 개선)
```

### 2. 월지와 일지의 합충 분석

```
예: 일지가 子(자)이고, 11월 경자(庚子)월인 경우

분석:
- 일지 子 + 월지 子 = 같은 지지 (자자형 가능)
- 같은 기운이 모여 수(水) 에너지 극대화
- 물은 지혜, 교류, 유동성 의미

결론: 학습/교류/이사/이직에 좋은 달
      다만 한쪽으로 치우칠 수 있어 균형 필요
```

### 3. 주간별 길흉 판단

```
주차별 천간 흐름을 분석하여 길일/흉일 도출:
- 1주차: 월초 기운 정착 기간
- 2주차: 월의 본 기운 발현
- 3주차: 전환점 (상반월/하반월)
- 4주차: 마무리 및 다음달 준비

길일: 용신과 조화되는 일진
흉일: 기신이 강하거나 충이 있는 일진
```

## 개선된 시스템 프롬프트

```
당신은 30년 경력의 사주명리학 전문가입니다.
사용자의 원국(사주 팔자)과 평생운세 분석을 바탕으로 {year}년 {month}월 {monthGanji}의 운세를 상세히 분석합니다.

## 분석 원칙

### 1. 월간지와 용신/기신 상호작용
- 이번달 천간/지지와 사용자 용신의 관계 분석
- 월간이 용신을 돕는지, 억제하는지 판단
- 월지가 용신에 미치는 영향 분석

### 2. 월지와 일지의 합충 분석
- 이번달 지지(월지)와 사용자 일지의 관계
- 합(合): 협력, 결합, 좋은 인연
- 충(衝): 변화, 이동, 갈등 후 해소
- 형(刑): 시련, 성장의 기회
- 해(害): 소소한 방해, 주의 필요

### 3. 주간별 실질적 가이드
- 각 주차별 기운의 흐름
- 실제 날짜 기반 길일/흉일
- 구체적인 행동 지침

### 4. 구체적이고 실감나는 설명
- "이번달 {월지} 기운이 {이름}님의 {일간}에 {관계}를 형성하여..."
- 추상적 표현 금지
- 실생활에 바로 적용 가능한 조언

## 톤앤매너
- 현대적이고 친근한 설명
- 사주 용어는 쉽게 풀어서
- 긍정/부정 균형있게
- 실천 가능한 구체적 조언
```

## 개선된 사용자 프롬프트

```
## 사용자 원국 정보

### 사주 팔자
| 구분 | 천간 | 지지 |
|------|------|------|
| 년주 | {year_gan} | {year_ji} |
| 월주 | {month_gan} | {month_ji} |
| 일주 | {day_gan} (일간) | {day_ji} |
| 시주 | {hour_gan} | {hour_ji} |

### 일간 강약
- 점수: {day_strength.score}점
- 유형: {day_strength.type}

### 용신/기신
- 용신: {yongsin.yongsin}
- 희신: {yongsin.huisin}
- 기신: {yongsin.gisin}

### 원국 합충 정보
{hapchung}

## 이번달 정보
- 연월: {year}년 {month}월
- 월간지: {monthGanji}
- 월천간: {월천간} ({월천간오행})
- 월지지: {월지지} ({월지지오행})

## 평생 사주 분석 요약
### 성격/적성
{personality 요약}

### 이번달 관련 분야
- 직업운: {career 핵심}
- 재물운: {wealth 핵심}
- 건강운: {health 핵심}

## 분석 요청

위 원국 정보와 평생운세를 바탕으로 {year}년 {month}월 운세를 분석해주세요.

특히 다음을 반드시 포함:
1. 월천간 {월천간}과 일간 {day_gan}의 관계
2. 월지 {월지지}와 일지 {day_ji}의 합충 관계
3. 용신 {yongsin}과 이번달 오행의 상호작용
4. 주간별 구체적 가이드와 길일/흉일
```

## 개선된 JSON 스키마

```json
{
  "year": 2026,
  "month": 5,
  "monthGanji": "갑오(甲午)",
  "monthElement": {
    "heavenlyStem": { "char": "甲", "korean": "갑", "element": "목(木)" },
    "earthlyBranch": { "char": "午", "korean": "오", "element": "화(火)" }
  },

  "yongsinAnalysis": {
    "userYongsin": "금(金)",
    "monthElements": ["목(木)", "화(火)"],
    "interaction": "甲木은 금이 극하나, 午火가 금을 극함",
    "impact": "월간은 컨트롤 가능하나 월지의 화 기운이 용신을 소모. 에너지 관리 필수.",
    "favorability": "중하"
  },

  "hapchungAnalysis": {
    "userDayBranch": "子",
    "monthBranch": "午",
    "relationship": "子午衝 (자오충)",
    "meaning": "이번달 일지와 월지가 충돌합니다. 주거/직장/관계에서 변화 신호가 올 수 있으며, 감정 기복에 주의가 필요합니다.",
    "advice": "변화를 두려워하지 말고, 새로운 기회로 전환하세요"
  },

  "overallScore": 62,
  "overallSummary": "2026년 5월은 {이름}님에게 변화와 적응의 달입니다. 갑오(甲午)월의 강한 화(火) 기운이 평소 {성격특성}한 성향에 자극을 줄 수 있습니다. 일지 {일지}와 월지 午가 {합충관계}를 이루어 예상치 못한 변화가 찾아올 수 있으나, 이는 더 나은 방향으로 가기 위한 과정입니다. 특히 중순에 중요한 전환점이 있을 수 있으니, 열린 마음으로 대처하시면 좋겠습니다.",

  "weekly": {
    "week1": {
      "dates": "5월 1일(목) ~ 7일(수)",
      "theme": "적응과 준비",
      "score": 58,
      "analysis": "월초에는 새로운 기운이 자리잡는 시기입니다. 甲午월의 화(火) 에너지가 본격화되기 전이라 상대적으로 안정적입니다. 이 시기에 이번달 계획을 정리하고, 체력 관리에 신경 쓰세요.",
      "doThis": ["월간 목표 정리", "충분한 수면", "가벼운 운동"],
      "avoidThis": ["무리한 약속", "큰 지출", "감정적 대응"],
      "luckyDays": [3, 5],
      "cautionDays": [2]
    },
    "week2": {
      "dates": "5월 8일(목) ~ 14일(수)",
      "theme": "활기와 도전",
      "score": 65,
      "analysis": "월의 본 기운이 발현되는 시기입니다. 화(火) 에너지가 활발해지면서 의욕이 높아지지만, 조급함도 생길 수 있습니다. 중요한 미팅이나 발표가 있다면 이 주에 진행하시면 에너지를 잘 활용할 수 있습니다.",
      "doThis": ["적극적 커뮤니케이션", "프로젝트 추진", "운동으로 에너지 발산"],
      "avoidThis": ["성급한 결정", "논쟁", "밤샘"],
      "luckyDays": [9, 12],
      "cautionDays": [11]
    },
    "week3": {
      "dates": "5월 15일(목) ~ 21일(수)",
      "theme": "전환점",
      "score": 60,
      "analysis": "이번달의 핵심 주차입니다. {합충관계}가 가장 강하게 작용하는 시기로, 예상치 못한 소식이나 제안이 올 수 있습니다. 유연한 대처가 필요하며, 감정보다 이성적 판단을 우선하세요.",
      "doThis": ["열린 마음", "명상/산책", "신뢰할 수 있는 사람과 대화"],
      "avoidThis": ["중요한 계약", "과격한 발언", "무리한 일정"],
      "luckyDays": [17, 20],
      "cautionDays": [15, 18]
    },
    "week4": {
      "dates": "5월 22일(목) ~ 31일(토)",
      "theme": "마무리와 회복",
      "score": 68,
      "analysis": "화(火) 기운이 서서히 줄어들면서 안정을 찾는 시기입니다. 이번달 겪은 변화를 정리하고, 다음달을 준비하세요. 하반기에 점수가 높아지듯, 월말로 갈수록 운기가 상승합니다.",
      "doThis": ["이번달 성과 정리", "감사 표현", "휴식과 재충전"],
      "avoidThis": ["새로운 시작", "무리한 마무리", "건강 무시"],
      "luckyDays": [24, 27, 30],
      "cautionDays": [26]
    }
  },

  "categories": {
    "career": {
      "score": 65,
      "title": "직업/사업운",
      "analysis": "{직업운 특성}을 가지고 계신 {이름}님, 이번달은 새로운 아이디어가 샘솟는 시기입니다. 甲(목) 기운이 창의성을 자극하지만, 午(화)의 급한 기운이 섞여 조급해질 수 있습니다. 아이디어는 이번달에 정리하고, 실행은 다음달로 미루시는 것도 방법입니다.",
      "weeklyTip": "2주차에 브레인스토밍, 4주차에 정리"
    },
    "wealth": {
      "score": 55,
      "title": "재물운",
      "analysis": "이번달은 지출이 늘어나기 쉬운 달입니다. 화(火) 기운이 강해 충동구매 욕구가 생길 수 있으니, 큰 지출은 한 박자 쉬어가세요. 특히 2-3주차에 예상치 못한 지출이 생길 수 있으니 여유자금을 확보해두시면 좋겠습니다.",
      "weeklyTip": "1주차에 예산 점검, 4주차에 결산"
    },
    "love": {
      "score": 70,
      "title": "애정운",
      "analysis": "화(火) 기운은 열정과 매력을 높여줍니다. 솔로이신 분은 새로운 만남에 적극적으로 임해보세요. 커플이신 분은 함께 활동적인 데이트를 즐기시면 관계가 더욱 가까워집니다. 다만 3주차에는 감정 기복에 주의하세요.",
      "weeklyTip": "2주차 데이트 추천, 3주차 대화로 풀기"
    },
    "health": {
      "score": 60,
      "title": "건강운",
      "analysis": "午(화)월이라 심장/혈관, 눈 건강에 신경 쓰세요. {건강 취약 부위}에 특히 주의가 필요합니다. 화 기운이 강해 열이 오르기 쉬우니, 시원한 음식과 충분한 수분 섭취가 도움됩니다. 격한 운동보다는 수영, 요가 등 시원한 운동이 좋습니다.",
      "weeklyTip": "1주차 건강검진, 3주차 충분한 휴식"
    }
  },

  "luckyElements": {
    "colors": {
      "recommended": "흰색, 은색, 파란색",
      "avoid": "빨간색, 주황색",
      "reason": "금(金)과 수(水) 색상으로 화(火) 기운 중화"
    },
    "foods": {
      "recommended": "시원한 음식, 해산물, 흰 채소",
      "avoid": "매운 음식, 튀김류",
      "reason": "수(水) 기운 보충으로 균형 유지"
    }
  },

  "luckyDays": {
    "best": [
      { "date": 5, "day": "월", "reason": "금(金) 일진으로 용신에 유리" },
      { "date": 12, "day": "월", "reason": "수(水) 일진으로 화를 제어" },
      { "date": 24, "day": "토", "reason": "토(土) 일진으로 안정적" }
    ],
    "caution": [
      { "date": 11, "day": "일", "reason": "화(火) 일진 극대화" },
      { "date": 18, "day": "일", "reason": "충(衝) 작용 강화" }
    ]
  },

  "monthAdvice": {
    "coreMessage": "5월의 키워드는 '유연한 적응'입니다.",
    "detailedAdvice": "이번달은 변화의 바람이 부는 달입니다. {합충관계}로 인해 예상치 못한 일이 생길 수 있지만, 이는 정체된 에너지를 움직이게 하는 좋은 기회이기도 합니다. 변화를 두려워하기보다 열린 마음으로 받아들이시면, 이번달 말에는 한 단계 성장한 자신을 발견하실 수 있습니다.",
    "weeklyFocus": [
      "1주차: 계획 수립과 체력 관리",
      "2주차: 적극적 행동과 커뮤니케이션",
      "3주차: 유연한 대처와 감정 관리",
      "4주차: 정리와 다음달 준비"
    ]
  }
}
```

## maxTokens 설정

```dart
@override
int get maxTokens => TokenLimits.monthlyFortuneMaxTokens; // 4096
```

## 동적 월간지 계산

```dart
/// 월별 간지 계산 (연도별 동적 생성)
String _getMonthGanji(int year, int month) {
  // 년간에 따른 월간 시작 계산
  // 갑/기년: 병인월 시작
  // 을/경년: 무인월 시작
  // 병/신년: 경인월 시작 (2026년)
  // 정/임년: 임인월 시작
  // 무/계년: 갑인월 시작

  const heavenlyStems = ['甲', '乙', '丙', '丁', '戊', '己', '庚', '辛', '壬', '癸'];
  const earthlyBranches = ['子', '丑', '寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥'];

  // 계산 로직...
  return '$천간$지지';
}
```

## 구현 체크리스트

- [ ] _getMonthGanji() 동적 계산으로 변경
- [ ] FortuneInputData에 saju_analyses 데이터 추가
- [ ] yongsin, hapchung 포맷팅 메서드 추가
- [ ] 시스템 프롬프트 개선
- [ ] JSON 스키마 개선 (주간별 상세 분석)
- [ ] maxTokens를 TokenLimits.monthlyFortuneMaxTokens로 변경
- [ ] 길일/흉일 구체적 날짜 계산 로직
