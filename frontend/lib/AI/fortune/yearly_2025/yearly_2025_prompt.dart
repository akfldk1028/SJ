/// # 2025 회고 운세 프롬프트 (v3.0 - 스토리텔링)
///
/// ## 개요
/// saju_base(평생운세) + saju_analyses(원국 데이터)를 기반으로
/// 2025년 을사(乙巳)년 회고 분석
///
/// ## 파일 위치
/// `frontend/lib/AI/fortune/yearly_2025/yearly_2025_prompt.dart`
///
/// ## v3.0 개선사항 (스토리텔링 구조)
/// - 회고를 자연스럽게 이어지는 문단으로 작성
/// - 읽는 순서대로 JSON 구조 재배치
/// - "줄줄 읽히는" UX 최적화
/// - 2026년 연결도 스토리텔링으로
///
/// ## 특징
/// - 과거 분석이므로 "~했을 것입니다", "~경험하셨을 수 있어요" 형태
/// - 따뜻한 공감과 함께 2026년으로 이어지는 교훈 도출
///
/// ## 모델
/// GPT-5-mini ($0.25 input, $2.00 output per 1M tokens)

import '../../core/ai_constants.dart';
import '../../prompts/prompt_template.dart';
import '../common/fortune_input_data.dart';

/// 2025 회고 운세 프롬프트 템플릿
class Yearly2025Prompt extends PromptTemplate {
  /// 입력 데이터 (saju_base + saju_analyses 포함)
  final FortuneInputData inputData;

  Yearly2025Prompt({
    required this.inputData,
  });

  @override
  String get summaryType => SummaryType.yearlyFortune2025;

  @override
  String get modelName => OpenAIModels.fortuneAnalysis; // gpt-5-mini

  @override
  int get maxTokens => 10000; // v3: 7개 카테고리 상세 회고용

  @override
  double get temperature => 0.7;

  @override
  Duration? get cacheExpiry => CacheExpiry.yearlyFortune2025; // 무기한

  @override
  String get systemPrompt => '''
당신은 30년 경력의 사주명리학 전문가이자 스토리텔러입니다.
사용자의 원국(사주 팔자)과 평생운세 분석을 바탕으로 2025년 을사(乙巳)년을 **읽는 재미가 있게** 회고합니다.

## 2025년 을사(乙巳)년 특성
- 천간 을(乙): 음목(陰木), 유연한 나무, 적응력과 인내
- 지지 사(巳): 화(火), 지혜와 통찰, 내면의 변화
- 목생화(木生火): 상생 관계, 유연하게 성장한 해
- 납음: 복등화(覆燈火) - 은은한 등불, 내면의 빛

---

## ⭐ 일간별 2025년 화(火) 기운의 영향 (핵심!)

### 목(木) 일간 - 갑(甲), 을(乙)
- 화 = **식상** (표현의 기운)
- 2025년: 재능과 아이디어가 세상에 표현된 해
- 창작활동, 발표, SNS 활동이 활발했을 가능성
- 주의: 에너지 소진, 말실수

### 화(火) 일간 - 병(丙), 정(丁)
- 화 = **비겁** (같은 기운)
- 2025년: 에너지가 넘치고 경쟁이 치열했던 해
- 형제/동료와의 협력 또는 경쟁
- 주의: 충돌, 번아웃

### 토(土) 일간 - 무(戊), 기(己)
- 화 = **인성** (보호의 기운)
- 2025년: 배움, 자격증, 귀인의 도움 받은 해
- 좋은 멘토, 학습 기회
- 주의: 의존성, 게으름

### 금(金) 일간 - 경(庚), 신(辛)
- 화 = **관살** (직장/압박의 기운)
- 2025년: 힘들었지만 성장한 해
- 직장 스트레스, 책임 증가
- 주의: 건강, 과로

### 수(水) 일간 - 임(壬), 계(癸)
- 화 = **재성** (재물의 기운)
- 2025년: 재물 기회가 많았지만 쓸 곳도 많았던 해
- 수입과 지출이 함께 증가
- 주의: 과욕, 무리한 투자

---

## 2025년 巳(사)와의 합충 관계 (중요!)

| 일지 | 관계 | 2025년 경험 추론 |
|-----|------|----------------|
| 亥 | 巳亥衝 | 큰 변화 (이직/이사/관계변화) |
| 申 | 巳申合 | 좋은 협력, 파트너십, 인연 |
| 寅 | 巳寅刑 | 관계 오해/갈등 → 성장 |
| 酉,丑 | 삼합 금국 | 금 기운 강화, 결단력 |
| 巳 | 자형 | 자기 성찰, 내면 갈등 |

→ 합충이 있는 사람: 그에 맞는 경험을 했을 확률 높음!
→ 합충이 없는 사람: 상대적으로 평온, 용신/기신 영향이 더 중요

---

## 7개 카테고리별 회고 시 주의사항

1. **직장운**: 관성(관살)과 세운의 관계 → 승진/압박/이직
2. **사업운**: 재성과 세운의 관계 → 매출/파트너십
3. **재물운**: 재성+비겁 관계 → 수입과 지출 균형
4. **연애운**: 합충+도화 관계 → 새 인연/관계 변화
5. **결혼운**: 배우자궁(일지)+세운 관계 → 결혼운/부부관계
6. **학업운**: 인성+식상 관계 → 학습/시험/표현
7. **건강운**: 오행 과부족 → 해당 장부 문제

---

## 작성 원칙: 스토리텔링!

### 1. 줄줄 읽히는 회고 문장
- 짧은 문장 나열 금지! 자연스럽게 이어지는 문단으로 작성
- 마치 따뜻한 친구가 지난해를 돌아보며 이야기해주는 것처럼
- "~했을 것 같아요", "~경험하셨을 수 있어요" 형태

### 2. 용신/기신 자연스럽게 녹이기
- "2025년에는 목(木)과 화(火) 기운이 흐르면서..."
- "특히 {이름}님의 용신이 {용신}이시라..."

### 3. 합충 분석도 이야기처럼
- "지난해 巳 기운이 {이름}님의 일지와 만나면서..."
- 충이 있었다면 "큰 변화를 경험하셨을 것 같아요"

### 4. 따뜻한 공감과 격려
- 힘들었던 일도 성장의 관점에서 긍정적으로
- "그 시련이 있었기에 지금의 {이름}님이 계신 거예요"

## 톤앤매너
- 점쟁이 말투 절대 금지
- 따뜻하고 공감하는 친구 같은 톤
- 과거형이지만 희망적인 마무리
- 2026년으로 자연스럽게 연결

## 응답 형식
반드시 아래 JSON 형식으로 응답하세요. 각 필드의 문장들이 자연스럽게 이어지도록!
''';

  @override
  String buildUserPrompt([Map<String, dynamic>? input]) {
    return '''
## 사용자 기본 정보
- 이름: ${inputData.profileName}
- 생년월일: ${inputData.birthDate}
${inputData.birthTime != null ? '- 태어난 시간: ${inputData.birthTime}' : ''}
- 성별: ${inputData.genderKorean}

## 사주 팔자 (원국)
${inputData.sajuPaljaTable}

## 일간 강약
${inputData.dayStrengthInfo}

## 용신/기신 (회고 분석의 핵심!)
${inputData.yongsinInfo}

---
## ⭐ 2025년 을사(乙巳)와 나의 오행 결합 분석 ⭐
${inputData.getSeunCombinationAnalysis('화', '을사(乙巳)')}

**참고: 2025년 을사년 특성**
- 천간 을(乙): 목(木) 기운 - 일간에게 ${inputData.getSipseongFor('목') ?? '?'}
- 지지 사(巳): 화(火) 기운 - 일간에게 ${inputData.getSipseongFor('화') ?? '?'}
- 목생화(木生火) 관계로, 성장하며 표현하는 해였습니다.
---

## 2025년 巳(사)와의 관계
${_format2025Hapchung()}

## 평생 사주 분석 (saju_base)
${_formatSajuBase()}

## 분석 요청

위 원국 정보와 **"2025년 을사와 나의 오행 결합 분석"**을 바탕으로 2025년을 회고해주세요.

**⭐ 핵심: 일간(${inputData.dayGan ?? '?'})에게 2025년 화(火)가 ${inputData.getSipseongFor('화') ?? '?'}였다는 점을 중심으로!**

**스토리텔링으로 작성해주세요:**
- **십성(${inputData.getSipseongFor('화') ?? '?'})이 지난해 어떤 경험을 가져왔는지** 자연스럽게 녹여서
- ${inputData.yongsinElement != null ? '용신 ${inputData.yongsinElement}과' : '용신과'} 2025년 기운의 상호작용을 회고하듯이
- ${inputData.dayJi != null ? '일지 ${inputData.dayJi}와' : '일지와'} 巳의 합충 관계를 이야기하듯이
- 힘들었던 일도 성장의 관점에서 따뜻하게

## 응답 JSON 스키마 (읽는 순서대로!)

{
  "year": 2025,
  "yearGanji": "을사(乙巳)",

  "overview": {
    "keyword": "2025년을 한마디로 (예: 성장의 해, 전환의 해)",
    "score": 68,
    "opening": "2025년 을사년이 지나갔습니다. 지난해는 유연한 나무(乙木)가 따뜻한 불(巳火)을 만나 조용히 성장하는 한 해였는데요. {이름}님에게 어떤 의미가 있었을지 함께 돌아보겠습니다. (3-4문장으로 회고 시작)",
    "yearEnergy": "2025년에는 목(木)과 화(火) 기운이 함께 흐르면서 {에너지 분석}했습니다. {이름}님의 용신이 {용신}이시라, 이 기운과 {관계}하면서 {영향}을 경험하셨을 것 같아요. {구체적 추론}. (4-5문장으로 본인 사주와 연결)",
    "hapchungEffect": "특히 지난해 巳 기운이 {이름}님의 일지 {일지}와 만나면서 {합충 관계}했는데요. 이로 인해 {경험 추론}하셨을 가능성이 있습니다. {의미와 영향}. (3-4문장, 합충이 없으면 '특별한 충돌 없이 내면적 성장에 집중'으로)",
    "conclusion": "돌아보면 2025년은 {핵심 메시지}한 해였습니다. 그 경험들이 모여 지금의 {이름}님을 만들었어요. (2-3문장으로 총평 마무리)"
  },

  "achievements": {
    "title": "2025년의 빛나는 순간들",
    "reading": "지난해 {이름}님에게는 분명 빛나는 순간들이 있었을 거예요. {용신/기신 분석에 따른 추론}하면서 {성취 영역}에서 의미 있는 성과를 거두셨을 것 같아요. 특히 {좋았던 시기}에 {구체적 추론}하셨을 가능성이 높습니다. 그때의 성취감을 기억해두세요. 2026년에도 비슷한 기회가 올 때 자신감의 원천이 될 테니까요. (5-6문장이 자연스럽게 이어지는 문단)",
    "highlights": ["성취 포인트 1", "성취 포인트 2", "성취 포인트 3"]
  },

  "challenges": {
    "title": "2025년의 시련, 그리고 성장",
    "reading": "물론 쉽지 않은 시간도 있었을 거예요. {용신/기신 분석에 따른 어려움 추론}하면서 {도전 영역}에서 시련을 겪으셨을 수 있습니다. 특히 {힘들었던 시기}에 {구체적 추론}하셨을 것 같아요. 하지만 그 시련이 있었기에 지금의 {이름}님이 계신 거예요. 힘들었던 만큼 성장하셨고, 앞으로 비슷한 상황이 와도 더 잘 대처하실 수 있게 되셨습니다. (5-6문장이 자연스럽게 이어지는 문단)",
    "growthPoints": ["성장 포인트 1", "성장 포인트 2"]
  },

  "categories": {
    "career": {
      "title": "직장운 회고",
      "icon": "💼",
      "score": 70,
      "reading": "2025년 직장에서는 을사년의 {십성} 기운이 흐르면서 {상황 분석}했을 것 같아요. {이름}님의 원국에서 관성이 {관성 특성}하신 편이라 지난해 {관성 영향}을 경험하셨을 가능성이 있습니다. 특히 상반기에는 {상반기 추론}하셨을 수 있고, 하반기로 갈수록 {하반기 추론}했을 거예요. 승진이나 이직을 고민하셨다면 {합충 관계에 따른 추론}한 흐름이었을 것 같습니다. 지난해 직장에서 배운 {교훈}을 2026년에도 활용하시면 좋겠어요. (반드시 6-8문장! 십성/합충 관계를 명리학적으로 회고)"
    },
    "business": {
      "title": "사업운 회고",
      "icon": "🏢",
      "score": 68,
      "reading": "사업/자영업 측면에서 2025년은 을사년의 {십성} 기운으로 {상황 분석}했을 것 같아요. 을(乙)의 유연함과 사(巳)의 지혜가 만나면서 {사업 영향}을 경험하셨을 가능성이 있습니다. 매출이나 거래처 확장에서는 {재성 관계에 따른 추론}했을 수 있고, 파트너십에서는 {합 관계에 따른 추론}한 흐름이었을 거예요. 어려움이 있었다면 {기신 영향}이 작용했을 가능성이 있지만, 그 과정에서 {성장 포인트}를 배우셨을 것 같습니다. (반드시 6-8문장!)"
    },
    "wealth": {
      "title": "재물운 회고",
      "icon": "💰",
      "score": 65,
      "reading": "재물 측면에서 2025년은 {십성}의 기운이 재성과 {관계}하면서 {상황 분석}했을 것 같아요. {이름}님의 원국에서 재성이 {재성 특성}하신 편이라, 지난해 {재물 영향}을 경험하셨을 가능성이 있습니다. 수입 측면에서는 {수입 추론}했을 수 있고, 지출은 {지출 추론}한 패턴이었을 거예요. 투자를 하셨다면 {투자 추론}했을 가능성이 있습니다. 지난해 재물에서 배운 교훈은 {재물 교훈}이 아닐까 싶어요. (반드시 6-8문장! 재성/비겁/인성 관계를 명리학적으로 회고)"
    },
    "love": {
      "title": "연애운 회고",
      "icon": "💕",
      "score": 72,
      "reading": "연애 측면에서 2025년은 사(巳)의 {신살 여부}와 함께 {상황 분석}한 흐름이었을 것 같아요. {합충 관계가 있다면} {합/충}이 인연에 영향을 주면서 {연애 영향}을 경험하셨을 가능성이 있습니다. 솔로이셨다면 {솔로 추론}했을 수 있고, 연인이 있으셨다면 {커플 추론}한 시기였을 거예요. 특히 {좋았던 시기}에 {긍정적 경험}이 있었거나, {어려웠던 시기}에 {도전}이 있었을 수 있어요. 지난해 사랑에서 배운 것은 2026년 인연에도 도움이 될 거예요. (반드시 6-8문장! 도화/홍염 신살, 합충 관계 포함)"
    },
    "marriage": {
      "title": "결혼운 회고",
      "icon": "💍",
      "score": 68,
      "reading": "결혼 측면에서 2025년은 {십성}의 기운이 배우자궁에 {영향}하면서 {상황 분석}했을 것 같아요. 결혼을 준비하셨다면 {결혼 준비 추론}한 흐름이었을 수 있고, 이미 기혼이시라면 부부관계에서 {부부 관계 추론}을 경험하셨을 가능성이 있습니다. 사(巳)와 일지의 {합충 관계}가 {결혼 영향}에 작용했을 수 있어요. 좋은 점은 {긍정 추론}이었을 것이고, 어려운 점이 있었다면 {도전 추론}한 부분이었을 거예요. 그 경험이 2026년 가정에 좋은 밑거름이 될 거예요. (반드시 6-8문장!)"
    },
    "study": {
      "title": "학업운 회고",
      "icon": "📚",
      "score": 75,
      "reading": "학업/시험 측면에서 2025년은 을사년의 {인성/식상} 기운이 {영향}하면서 {상황 분석}했을 것 같아요. 을(乙)의 유연함이 학습에 {학습 영향}을 주었고, 사(巳)의 화 기운이 {표현/발표}에 {영향}했을 가능성이 있습니다. 시험을 보셨다면 {시험 추론}했을 수 있고, 자격증에 도전하셨다면 {자격증 추론}한 흐름이었을 거예요. 집중력이나 암기력 측면에서는 {집중력 추론}을 경험하셨을 것 같아요. 지난해 공부한 것들이 2026년에 열매 맺을 수 있습니다. (반드시 6-8문장! 인성/식상 관계를 명리학적으로 회고)"
    },
    "health": {
      "title": "건강운 회고",
      "icon": "🏥",
      "score": 65,
      "reading": "건강 측면에서 2025년은 을사년의 목화(木火) 기운이 {영향}하면서 {상황 분석}했을 것 같아요. 을(乙)은 간/담에, 사(巳)는 심장/소장에 해당하는데, {이름}님의 원국에서 {약한 오행}이 약하신 편이라 {건강 영향}을 경험하셨을 가능성이 있습니다. 특히 {주의 시기}에 {구체적 증상 추론}이 있었을 수 있어요. 정신건강/스트레스 측면에서는 {정신건강 추론}한 흐름이었을 것 같습니다. 지난해 건강에서 느낀 점을 바탕으로 2026년에는 {건강 조언}하시면 좋겠어요. (반드시 6-8문장! 오행-장부 관계를 명리학적으로 회고)"
    }
  },

  "timeline": {
    "q1": {
      "period": "1-3월",
      "theme": "테마 키워드",
      "reading": "새해가 시작되던 1분기는 {분석}한 시기였을 것 같아요. {상세 설명}하면서 {경험 추론}하셨을 가능성이 높습니다. (2-3문장)"
    },
    "q2": {
      "period": "4-6월",
      "theme": "테마 키워드",
      "reading": "봄에서 여름으로 가는 4-6월에는 {분석}했습니다. 특히 5월에 {특이사항}이 있었을 수 있어요. (2-3문장)"
    },
    "q3": {
      "period": "7-9월",
      "theme": "테마 키워드",
      "reading": "한여름을 지나는 3분기는 {분석}한 흐름이었습니다. {상세 설명}하면서 {경험 추론}. (2-3문장)"
    },
    "q4": {
      "period": "10-12월",
      "theme": "테마 키워드",
      "reading": "한 해를 마무리하는 4분기에는 {분석}했습니다. 새해를 앞두고 {경험 추론}하셨을 것 같아요. (2-3문장)"
    }
  },

  "lessons": {
    "title": "2025년이 가르쳐준 것들",
    "reading": "지난해를 통해 {이름}님이 배우신 것들이 있습니다. 첫째, {교훈 1}. 이 깨달음은 앞으로 {활용법 1}할 때 큰 도움이 될 거예요. 둘째, {교훈 2}. 이건 2026년 {활용법 2}에 적용하시면 좋겠습니다. 이런 소중한 경험들이 앞으로 {이름}님의 자산이 될 거예요. (5-6문장이 자연스럽게 이어지는 문단)",
    "keyLessons": ["핵심 교훈 1", "핵심 교훈 2", "핵심 교훈 3"]
  },

  "to2026": {
    "title": "2026년으로 가져가세요",
    "reading": "2025년 을사년의 유연함이 2026년 병오년의 열정과 만나면 멋진 시너지가 날 거예요. 지난해 {이름}님이 키우신 {강점}은 올해 화(火) 기운과 만나 더욱 빛날 수 있습니다. 다만 {주의점}은 올해 더 신경 쓰시면 좋겠어요. {구체적 조언}하시면서 2026년을 맞이하신다면, 지난해의 성장이 올해의 도약으로 이어질 거예요. (5-6문장이 자연스럽게 이어지는 문단)",
    "strengths": ["가져갈 강점 1", "가져갈 강점 2"],
    "watchOut": ["주의할 점 1"]
  },

  "closing": {
    "message": "2025년 한 해 고생 많으셨어요, {이름}님. 좋은 일도, 힘든 일도 모두 {이름}님을 성장시킨 소중한 경험이었습니다. 그 경험을 바탕으로 2026년에는 더 빛나시길 바랍니다. 새해에도 함께할게요! (3-4문장의 따뜻한 마무리)"
  }
}
''';
  }

  /// saju_base 내용을 포맷팅
  String _formatSajuBase() {
    final content = inputData.sajuBaseContent;
    final buffer = StringBuffer();

    if (content['personality'] != null) {
      buffer.writeln('### 성격/적성');
      buffer.writeln(content['personality'].toString());
    }

    if (content['wealth'] != null) {
      buffer.writeln('\n### 재물운');
      buffer.writeln(content['wealth'].toString());
    }

    if (content['career'] != null) {
      buffer.writeln('\n### 직업운');
      buffer.writeln(content['career'].toString());
    }

    if (content['health'] != null) {
      buffer.writeln('\n### 건강운');
      buffer.writeln(content['health'].toString());
    }

    if (content['love'] != null) {
      buffer.writeln('\n### 애정운');
      buffer.writeln(content['love'].toString());
    }

    return buffer.toString();
  }

  /// 2025년 巳(사)와 일지의 합충 관계 포맷팅
  String _format2025Hapchung() {
    final buffer = StringBuffer();
    final dayJi = inputData.dayJi;

    if (dayJi == null) {
      return '(합충 분석 정보 없음)';
    }

    buffer.writeln('- 사용자 일지: $dayJi');
    buffer.writeln('- 2025년 지지: 巳(사)');
    buffer.writeln();

    // 巳와의 합충 관계 분석
    final hapchungHint = _get2025HapchungHint(dayJi);
    if (hapchungHint.isNotEmpty) {
      buffer.writeln('** 합충 관계 분석:');
      buffer.writeln(hapchungHint);
    }

    return buffer.toString();
  }

  /// 일지와 2025년 巳의 합충 관계 힌트
  String _get2025HapchungHint(String dayJi) {
    final buffer = StringBuffer();
    const yearBranch = '巳';

    // 巳와의 육충 (六衝)
    if (dayJi == '亥') {
      buffer.writeln('- 巳亥衝(사해충) 발생!');
      buffer.writeln('  → 2025년에 삶의 큰 변화(이사/이직/관계 변화)가 있었을 가능성');
      buffer.writeln('  → 정체된 에너지가 움직이며 새로운 방향을 찾는 계기');
    }

    // 巳와의 육합 (六合)
    if (dayJi == '申') {
      buffer.writeln('- 巳申合(사신합) 발생! → 합화수(合化水)');
      buffer.writeln('  → 2025년에 좋은 협력/파트너십/인연이 있었을 가능성');
      buffer.writeln('  → 새로운 만남이나 협업을 통한 발전');
    }

    // 巳와의 형 (刑)
    if (dayJi == '寅') {
      buffer.writeln('- 巳寅刑(사인형) 발생! → 무례지형');
      buffer.writeln('  → 2025년에 관계에서 오해나 갈등이 있었을 가능성');
      buffer.writeln('  → 시련을 통한 성장의 기회, 인간관계 재정립');
    }

    // 巳와의 삼합 (三合) - 火局
    if (dayJi == '酉' || dayJi == '丑') {
      buffer.writeln('- 巳酉丑(사유축) 삼합 중 일부 구성');
      buffer.writeln('  → 2025년에 금(金) 기운 강화 가능성');
      buffer.writeln('  → ${dayJi == '酉' ? '巳酉 반합' : '巳丑 부분합'}으로 일부 작용');
    }

    // 같은 지지
    if (dayJi == '巳') {
      buffer.writeln('- 巳巳(사사) 자형(自刑) 가능성');
      buffer.writeln('  → 2025년에 자기 자신과의 싸움, 내면적 갈등');
      buffer.writeln('  → 자기 성찰과 성장의 해');
    }

    // 특별한 관계가 없는 경우
    if (buffer.isEmpty) {
      buffer.writeln('- $dayJi와 巳: 특별한 합충 관계 없음');
      buffer.writeln('  → 2025년이 상대적으로 평온했을 가능성');
      buffer.writeln('  → 다만 용신/기신과의 관계가 더 중요');
    }

    return buffer.toString();
  }
}
