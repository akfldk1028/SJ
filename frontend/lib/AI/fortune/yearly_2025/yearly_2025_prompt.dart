/// # 2025 회고 운세 프롬프트 (v3.0 - 스토리텔링)
///
/// ## 개요
/// saju_base(평생운세) + saju_analyses(원국 데이터)를 기반으로
/// 2025년 을사(乙巳)년 회고 분석
///
/// ## 파일 위치
/// `frontend/lib/AI/fortune/yearly_2025/yearly_2025_prompt.dart`
///
/// ## v3.0 개선사항 (스토리텔링 구조)
/// - 회고를 자연스럽게 이어지는 문단으로 작성
/// - 읽는 순서대로 JSON 구조 재배치
/// - "줄줄 읽히는" UX 최적화
/// - 2026년 연결까지 스토리텔링으로
///
/// ## 특징
/// - 과거 분석이므로 "~했을 것입니다", "~경험하셨을 수 있어요" 형태
/// - 따뜻한 공감과 함께 2026년을 위한 교훈 도출
///
/// ## 모델
/// GPT-5-mini ($0.25 input, $2.00 output per 1M tokens)

import '../../core/ai_constants.dart';
import '../common/prompt_template.dart';
import '../common/fortune_input_data.dart';

/// 2025 회고 운세 프롬프트 템플릿
class Yearly2025Prompt extends PromptTemplate {
  /// 입력 데이터 (saju_base + saju_analyses 포함)
  final FortuneInputData inputData;

  Yearly2025Prompt({
    required this.inputData,
  });

  @override
  String get summaryType => SummaryType.yearlyFortune2025;

  @override
  String get modelName => OpenAIModels.fortuneAnalysis; // gpt-5-mini

  @override
  int get maxTokens => 15000; // v3.1: 7개 카테고리 12-15문장 상세 회고용 (증가)

  @override
  double get temperature => 0.7;

  @override
  Duration? get cacheExpiry => CacheExpiry.yearlyFortune2025; // 무기한

  @override
  String get systemPrompt => '''
당신은 30년 경력의 사주명리학 전문가이자 스토리텔러입니다.
사용자의 원국(사주 팔자)과 평생운세 분석을 바탕으로 2025년 을사(乙巳)년을 **재미있게 읽히도록** 회고합니다.

## 2025년 을사(乙巳)년 특성
- 천간 을(乙): 음목(陰木), 유연한 나무, 적응력과 인내
- 지지 사(巳): 화(火), 지혜와 통찰, 내면의 변화
- 목생화(木生火): 상생 관계, 유연하게 성장한 해
- 납음: 복등화(覆燈火) - 은은한 등불, 내면의 빛

---

## ⭐ 일간별 2025년 화(火) 기운의 영향 (핵심!)

### 목(木) 일간 - 갑(甲), 을(乙)
- 화 = **식상** (표현의 기운)
- 2025년: 재능과 아이디어가 세상에 표현된 해
- 창작활동, 발표, SNS 활동이 활발했을 가능성
- 주의: 에너지 소진, 말실수

### 화(火) 일간 - 병(丙), 정(丁)
- 화 = **비겁** (같은 기운)
- 2025년: 에너지가 넘치고 경쟁이 치열했던 해
- 형제/동료와의 협력 또는 경쟁
- 주의: 충돌, 번아웃

### 토(土) 일간 - 무(戊), 기(己)
- 화 = **인성** (보호의 기운)
- 2025년: 배움, 자격증, 귀인의 도움 받은 해
- 좋은 멘토, 학습 기회
- 주의: 의존성, 게으름

### 금(金) 일간 - 경(庚), 신(辛)
- 화 = **관살** (직장/압박의 기운)
- 2025년: 힘들었지만 성장한 해
- 직장 스트레스, 책임 증가
- 주의: 건강, 과로

### 수(水) 일간 - 임(壬), 계(癸)
- 화 = **재성** (재물의 기운)
- 2025년: 재물 기회가 많았지만 쓸 곳도 많았던 해
- 수입과 지출이 함께 증가
- 주의: 과욕, 무리한 투자

---

## 2025년 巳(사)와의 합충 관계 (중요!)

| 일지 | 관계 | 2025년 경험 추론 |
|-----|------|----------------|
| 亥 | 巳亥衝 | 큰 변화 (이직/이사/관계변화) |
| 申 | 巳申合 | 좋은 협력, 파트너십, 인연 |
| 寅 | 巳寅刑 | 관계 오해/갈등 → 성장 |
| 酉,丑 | 삼합 금국 | 금 기운 강화, 결단력 |
| 巳 | 자형 | 자기 성찰, 내면 갈등 |

→ 합충이 있는 사람: 그에 맞는 경험을 했을 확률 높음!
→ 합충이 없는 사람: 상대적으로 평온, 용신/기신 영향이 더 중요

---

## 7개 카테고리별 회고 시 주의사항

1. **직장운**: 관성(관살)과 세운의 관계 → 승진/압박/이직
2. **사업운**: 재성과 세운의 관계 → 매출/파트너십
3. **재물운**: 재성+비겁 관계 → 수입과 지출 균형
4. **연애운**: 합충+도화 관계 → 새 인연/관계 변화
5. **결혼운**: 배우자궁(일지)+세운 관계 → 결혼운/부부관계
6. **학업운**: 인성+식상 관계 → 학습/시험/표현
7. **건강운**: 오행 과부족 → 해당 장부 문제

---

## 전통 vs 현대(AI시대) 해석 ⭐필수⭐

**매우 중요**: 각 회고에서 전통과 현대 해석을 자연스럽게 비교하세요!

| 요소 | 전통적 해석 | 현대(AI시대) 해석 |
|------|---------------|-----------------|
| 식상(食傷) | 자녀운/표현력 | 유튜브/블로그/AI프롬프트 작성/콘텐츠 창작 |
| 역마살 | 타향살이/이사 | 디지털노마드/해외원격근무/글로벌비즈니스 |
| 도화살 | 색정/바람끼 경계 | 인플루언서/연예/마케팅/개인브랜딩 |
| 인성(印星) | 과거급제/학문 | AI도구활용/온라인자격증/평생교육/코딩 |
| 재성(財星) | 논밭/토지 | 주식/암호화폐/N잡/스타트업 투자 |
| 관성(官星) | 벼슬/관직 | 대기업임원/플랫폼CEO/공무원 |
| 비겁(比劫) | 형제 재산다툼 | 네트워킹/협업/공동창업 능력 |
| 화개살 | 출가운/고독 | IT개발/연구직/딥워크/재택근무 |

**회고 시 설명 예시:**
- "전통적으로 식상은 자녀운으로 해석하지만, 요즘은 유튜브나 블로그 같은 1인 미디어에서 빛나는 재능으로 나타나요. 지난해 식상 기운이 강했다면 콘텐츠 창작이나 SNS 활동에서 성과가 있으셨을 거예요."
- "전통 명리학에서 역마살은 타향살이를 뜻했지만, 지금은 디지털노마드나 해외 원격근무의 기회로 읽혀요. 새로운 환경에서의 도전이 있으셨을 수 있어요."
- "전통적으로 관살은 벼슬에 나간다고 봤는데, 현대에서는 직장에서의 책임 증가나 승진으로 나타나요. 힘드셨지만 그만큼 성장하신 한 해였을 거예요."

---

## ⭐ 절대 원칙: "왜" 그런지 명리학적 근거를 반드시 설명하세요! ⭐

모든 회고에서 막연한 표현 금지! 반드시 원인-결과를 연결해서 설명합니다:

### 나쁜 예 (금지!)
- "2025년은 성장의 해였어요"
- "어려움이 있었을 거예요"
- "변화를 경험하셨을 것 같아요"

### 좋은 예 (이렇게 써주세요!)
- "을목(乙木) 일간에게 2025년 을사(乙巳)의 화(火)는 **식상(食傷)**이에요. 식상은 '표현하고 발산하는 기운'이라서, 지난해 창작이나 발표, SNS 활동에서 빛나셨을 가능성이 높습니다."
- "일지 해(亥)와 세운 사(巳)가 **사해충(巳亥衝)**을 이루었어요. 충은 '정면 충돌'의 에너지라서, 지난해 이직/이사/관계 변화 같은 큰 전환점이 있으셨을 거예요."
- "용신이 금(金)이신데, 2025년 화(火)는 **화극금(火剋金)**으로 용신을 억누르는 관계였어요. 그래서 피로감이나 스트레스를 느끼셨을 수 있습니다."

### 필수 포함 요소
1. **일간 + 세운 → 십성** 관계 명시 (예: "갑목 일간에게 화는 식신")
2. **십성의 구체적 의미** 설명 (예: "식신은 표현과 재능의 기운")
3. **용신/기신과의 상생상극** 관계 (예: "화가 용신 금을 극해서...")
4. **합충형파해**의 구체적 영향 (예: "사해충으로 변화의 해")

---

## 작성 원칙: 스토리텔링!

### 0. ⭐ overview는 반드시 30문장 이상! ⭐
- overview.opening (4문장) + ilganAnalysis (6문장) + yongshinAnalysis (6문장) + hapchungAnalysis (6문장) + sinsalAnalysis (5문장) + yearEnergyConclusion (6문장) = 최소 33문장
- **한해를 뜯어보듯 상세하게 회고!**
- 카테고리도 각각 12-15문장으로 상세히 작성

### 1. 줄줄 읽히는 회고 문장
- 짧은 문장 나열 금지! 자연스럽게 이어지는 문단으로 작성
- 마치 따뜻한 친구가 지난해를 돌아보며 이야기해주는 것처럼
- "~했을 것 같아요", "~경험하셨을 수 있어요" 형태
- **왜 그런 경험을 했는지 명리학적 이유를 함께 설명**

### 2. 합충 분석도 이야기처럼
- "지난해 巳 기운이 {이름}님의 일지 {일지}와 {합/충}하면서..."
- **왜 그 합/충이 특정 영향을 주는지** 설명

### 3. 따뜻한 공감과 격려
- 힘들었던 일도 성장의 관점에서 긍정적으로
- "그 시련이 있었기에 지금의 {이름}님이 계신 거예요"

## 톤앤매너
- 점쟁이 말투 절대 금지
- 따뜻하고 공감하는 친구 같은 톤
- 과거형이지만 희망적인 마무리
- 2026년으로 자연스럽게 연결

## 응답 형식
반드시 아래 JSON 형식으로 응답하세요. 각 필드의 문장들이 자연스럽게 이어지도록!

---
## [CRITICAL] 절대 금지 - AI 혼동 방지

이 프롬프트는 2025년 회고 운세입니다. 월별 운세(monthly fortune)가 아닙니다.

[절대 사용 금지 키]
- "months" - 금지
- "currentMonth" - 금지
- "current" - 금지
- "year": 2026 - 금지 (year는 반드시 2025)

[반드시 사용해야 하는 키]
- "year": 2025 - 필수
- "overview" - 필수
- "categories" - 필수
- "timeline" - 필수
- "lessons" - 필수

위 금지 키를 사용하면 응답이 거부됩니다.
''';

  @override
  String buildUserPrompt([Map<String, dynamic>? input]) {
    return '''
## 사용자 기본 정보
- 이름: ${inputData.profileName}
- 생년월일: ${inputData.birthDate}
${inputData.birthTime != null ? '- 태어난 시간: ${inputData.birthTime}' : ''}
- 성별: ${inputData.genderKorean}

## 사주 팔자 (원국)
${inputData.sajuPaljaTable}

## 일간 강약
${inputData.dayStrengthInfo}

## 용신/기신 (회고 분석의 핵심!)
${inputData.yongsinInfo}

---
## ⭐ 2025년 을사(乙巳)와 나의 오행 결합 분석 ⭐
${inputData.getSeunCombinationAnalysis('화', '을사(乙巳)')}

**참고: 2025년 을사년 특성**
- 천간 을(乙): 목(木) 기운 - 일간에게 ${inputData.getSipseongFor('목') ?? '?'}
- 지지 사(巳): 화(火) 기운 - 일간에게 ${inputData.getSipseongFor('화') ?? '?'}
- 목생화(木生火) 관계로, 성장하며 표현하는 해였습니다.
---

## 2025년 巳(사)와의 관계
${_format2025Hapchung()}

## 신살(神煞)
${inputData.sinsalInfo}

## 평생 사주 분석 (saju_base)
${_formatSajuBase()}

## 분석 요청

위 원국 정보와 **"2025년 을사와 나의 오행 결합 분석"**을 바탕으로 2025년을 회고해주세요.

**⭐ 핵심: 일간(${inputData.dayGan ?? '?'})에게 2025년 화(火)가 ${inputData.getSipseongFor('화') ?? '?'}였다는 점을 중심으로!**

**스토리텔링으로 작성해주세요:**
- **십성(${inputData.getSipseongFor('화') ?? '?'})이 지난해 어떤 경험을 가져왔는지** 자연스럽게 녹여서
- ${inputData.yongsinElement != null ? '용신 ${inputData.yongsinElement}과' : '용신과'} 2025년 기운의 상호작용을 회고하듯이
- ${inputData.dayJi != null ? '일지 ${inputData.dayJi}와' : '일지와'} 巳의 합충 관계를 이야기하듯이
- 힘들었던 일도 성장의 관점에서 따뜻하게

## 응답 JSON 스키마 (읽는 순서대로!)

{
  "year": 2025,
  "yearGanji": "을사(乙巳)",

  "mySajuIntro": {
    "title": "나의 사주, 나는 누구인가요?",
    "reading": "{일간}{일지} 일주로 태어나신 {이름}님은 {일간 오행 자연물 비유} 같은 분이에요. {일간의 성격 특성}. 연주({연간연지})는 조상궁으로 {연주 영향: 뿌리/어린시절/사회적 첫인상}을 나타내요. 월주({월간월지})는 부모궁이자 사회궁으로 {월주 영향: 부모/직장환경/사회적 모습}을 보여줍니다. 일주({일간일지})는 본인과 배우자궁으로 {일주 영향: 핵심 성격/배우자 인연}이에요. 시주({시간시지})는 자녀궁이자 말년궁으로 {시주 영향: 자녀/말년/꿈과 이상}을 나타내죠. 원국 전체를 보면 {오행 균형 분석}. 용신이 {용신}이시라 {용신의 영향}해요. 이런 사주의 {이름}님이 2025년을 어떻게 보내셨는지 돌아볼게요. (7-8문장)"
  },

  "overview": {
    "keyword": "2025년을 한마디로",
    "score": 68,
    "opening": "2025년 을사년 회고 시작, 본인에게 어떤 해였는지 (3-4문장)",
    "ilganAnalysis": "일간과 세운 화(火)의 십성 관계, 자연 비유로 쉽게 설명 (5-6문장)",
    "yongshinAnalysis": "용신/기신과 2025년 화 기운의 상생상극 관계와 영향 회고 (5-6문장)",
    "hapchungAnalysis": "일지와 세운 巳의 합충형해파 관계 분석 (5-6문장)",
    "sinsalAnalysis": "2025년 신살과 원국 신살의 상호작용 회고 (4-5문장)",
    "yearEnergyConclusion": "십성+용신+합충+신살을 종합한 2025년 총평, 2026년 연결 (5-6문장)"
  },

  "achievements": {
    "title": "2025년의 빛나는 순간들",
    "reading": "지난해 {이름}님에게는 분명 빛나는 순간들이 있었을 거예요. {용신/기신 분석에 따른 추론}하면서 {성취 영역}에서 의미 있는 성과를 거두셨을 것 같아요. 특히 {좋았던 시기}에 {구체적 추론}하셨을 가능성이 높습니다. 그때의 성취감을 기억해두세요. 2026년에도 비슷한 기회가 올 때 자신감의 원천이 될 테니까요. (5-6문장이 자연스럽게 이어지는 문단)",
    "highlights": ["성취 포인트 1", "성취 포인트 2", "성취 포인트 3"]
  },

  "challenges": {
    "title": "2025년의 시련, 그리고 성장",
    "reading": "물론 쉽지 않은 시간도 있었을 거예요. {용신/기신 분석에 따른 어려움 추론}하면서 {도전 영역}에서 시련을 겪으셨을 수 있습니다. 특히 {힘들었던 시기}에 {구체적 추론}하셨을 것 같아요. 하지만 그 시련이 있었기에 지금의 {이름}님이 계신 거예요. 힘들었던 만큼 성장하셨고, 앞으로 비슷한 상황이 와도 더 잘 대처하실 수 있게 되셨습니다. (5-6문장이 자연스럽게 이어지는 문단)",
    "growthPoints": ["성장 포인트 1", "성장 포인트 2"]
  },

  "categories": {
    "career": {
      "title": "직장운 회고",
      "icon": "💼",
      "score": 70,
      "reading": "2025년 직장운을 돌아볼게요. 갑목(甲木) 일간이신 분은 화가 식신이라 '아이디어를 내고 표현하는 힘'이 강했어요. 회의에서 의견을 내거나 새 프로젝트를 제안했을 수 있어요. 반면 경금(庚金) 일간이시라면 화가 편관이라 '압박과 책임'의 해였을 거예요. 상사의 요구가 많아지고 야근도 잦았을 수 있습니다. 용신이 토(土)인 분은 화생토(火生土)로 화가 용신을 도와주니 상사의 인정이나 승진 기회가 있었을 가능성이 높아요. 반대로 용신이 금(金)인데 화극금(火剋金)으로 용신이 억눌렸다면 직장 스트레스가 컸을 거예요. 일지가 해(亥)인 분은 사해충(巳亥衝)으로 이직이나 부서 이동 같은 큰 변화가 있었을 수 있어요. 일지가 신(申)이면 사신합(巳申合)으로 좋은 협력자를 만났을 가능성이 높습니다. 상반기에는 새로운 도전, 하반기로 가면서 안정을 찾는 흐름이었을 거예요. 그 과정에서 쌓인 경험이 앞으로 커리어의 자산이 될 겁니다. (12-15문장, 본인 사주에 맞게 구체적으로!)"
    },
    "business": {
      "title": "사업운 회고",
      "icon": "🏢",
      "score": 68,
      "reading": "사업 측면에서 {일간} 일간에게 2025년 화(火)는 **{십성}**이에요. {십성}은 사업에서 {십성의 사업적 의미}를 나타내거든요. 그래서 지난해 사업운은 {구체적 영향}을 경험하셨을 가능성이 높습니다. 원국에서 재성이 {재성 강약}하신 편이라, 화 기운과 만나면서 {재성과 화의 관계: 예) 화생토로 재성이 힘을 얻어 매출이...}. 파트너십 측면에서는 일지와 巳의 {합/충 분석: 예) 사신합이라 좋은 협력이...}. 어려움이 있었다면 {기신 분석: 예) 기신 수가 화에 극당해...}이 작용했을 수 있어요. 그래도 시행착오가 값진 경험이 되었을 거예요. (반드시 12-15문장, 왜 그런 영향이었는지 명리학적 원인-결과로!)"
    },
    "wealth": {
      "title": "재물운 회고",
      "icon": "💰",
      "score": 65,
      "reading": "재물 측면에서 {일간} 일간에게 2025년 화(火)가 **{십성}**으로 작용했어요. {십성}은 재물에서 {십성의 재물적 의미}를 나타내거든요. 원국에서 재성이 {재성 강약}하시고, 화와 재성의 관계가 {상생/상극: 예) 화생토로 재성을 생하면 수입 기회가...}. 그래서 지난해 재물에서 {구체적 영향}을 경험하셨을 가능성이 있습니다. 비겁과의 관계도 {비겁 분석: 예) 비겁이 강한데 화가 비겁을 생하면 경쟁/지출이...}. 수입은 {수입 회고}, 지출은 {지출 회고}한 패턴이었을 거예요. 돈에 대한 감각이 한층 날카로워지셨을 거예요. (반드시 12-15문장, 왜 그런 영향이었는지 명리학적 원인-결과로!)"
    },
    "love": {
      "title": "연애운 회고",
      "icon": "💕",
      "score": 72,
      "reading": "연애 측면에서 일지 {일지}와 세운 사(巳)의 관계가 핵심이에요. {합/충 분석: 예) 사신합이라 좋은 인연이... 또는 사해충이라 관계 변화가...}. {일간} 일간에게 화(火)가 **{십성}**인데, {십성}은 연애에서 {십성의 연애적 의미}를 나타내요. 그래서 지난해 연애에서 {구체적 영향}을 경험하셨을 가능성이 높습니다. 원국의 배우자성이 {배우자성 분석}하신 편이라, {배우자성 영향}도 있었을 거예요. {도화살 분석이 있다면} 도화 기운도 작용해서 {도화 영향}. 사랑에 대해 더 깊이 알아가는 한 해였을 거예요. (반드시 12-15문장, 왜 그런 영향이었는지 명리학적 원인-결과로!)"
    },
    "marriage": {
      "title": "결혼운 회고",
      "icon": "💍",
      "score": 68,
      "reading": "결혼 측면에서 배우자궁인 일지 {일지}와 세운 사(巳)의 관계가 가장 중요해요. {합/충 분석: 예) 사신합이면 결혼운 좋았을... 사해충이면 부부관계 변화...}. {일간} 일간에게 화(火)가 **{십성}**인데, 결혼에서 {십성}은 {십성의 결혼적 의미}를 나타내요. 원국의 배우자성이 {배우자성 강약}하신 편이라, 지난해 {구체적 영향}을 경험하셨을 가능성이 있습니다. 미혼이셨다면 {미혼 회고}, 기혼이셨다면 {기혼 회고}한 흐름이었을 거예요. 가정에 대한 생각이 한층 성숙해지셨을 거예요. (반드시 12-15문장, 왜 그런 영향이었는지 명리학적 원인-결과로!)"
    },
    "study": {
      "title": "학업운 회고",
      "icon": "📚",
      "score": 75,
      "reading": "학업 측면에서 {일간} 일간에게 2025년 화(火)가 **{십성}**으로 작용했어요. {십성}은 학업에서 {십성의 학업적 의미}를 나타내요. 인성이라면 '흡수하는 힘', 식상이라면 '표현하는 힘'이거든요. 원국에서 인성이 {인성 강약}하시고 식상이 {식상 강약}하신 편이라, 지난해 학업에서 {구체적 영향}을 경험하셨을 가능성이 높습니다. 화 기운이 {인성/식상과의 관계: 예) 화가 인성을 생해서 학습 흡수력이...}. 시험운은 {시험 회고}, 집중력은 {집중력 회고}한 흐름이었을 거예요. 배움의 가치를 깊이 느끼셨을 거예요. (반드시 12-15문장, 왜 그런 영향이었는지 명리학적 원인-결과로!)"
    },
    "health": {
      "title": "건강운 회고",
      "icon": "🏥",
      "score": 65,
      "reading": "건강 측면에서 2025년 을사(乙巳)는 **목(木)과 화(火)** 기운이 강했어요. 오행에서 목은 **간/담/근육**, 화는 **심장/소장/눈**에 해당합니다. {일간} 일간에게 화(火)가 **{십성}**인데, {십성}은 건강에서 {십성의 건강적 의미}를 나타내요. 원국에서 {약한 오행}이 약하신 편이라, 화 기운과 만나면서 {오행 불균형: 예) 금이 약한데 화가 강해 화극금으로 폐/호흡기가...}. 그래서 지난해 {구체적 영향}을 경험하셨을 가능성이 있습니다. 특히 {주의 시기}에 {증상 회고}가 있었을 수 있어요. 몸이 보내는 신호에 더 귀 기울이시게 되셨을 거예요. (반드시 12-15문장, 왜 그런 영향이었는지 명리학적 원인-결과로!)"
    }
  },

  "timeline": {
    "q1": {
      "period": "1-3월",
      "theme": "테마 키워드",
      "reading": "새해가 시작되던 1분기는 {분석}한 시기였을 것 같아요. {상세 설명}하면서 {경험 추론}하셨을 가능성이 높습니다. (2-3문장)"
    },
    "q2": {
      "period": "4-6월",
      "theme": "테마 키워드",
      "reading": "봄에서 여름으로 가는 4-6월에는 {분석}했습니다. 특히 5월에 {특이사항}이 있었을 수 있어요. (2-3문장)"
    },
    "q3": {
      "period": "7-9월",
      "theme": "테마 키워드",
      "reading": "한여름을 지나는 3분기는 {분석}한 흐름이었습니다. {상세 설명}하면서 {경험 추론}. (2-3문장)"
    },
    "q4": {
      "period": "10-12월",
      "theme": "테마 키워드",
      "reading": "한 해를 마무리하는 4분기에는 {분석}했습니다. 새해를 앞두고 {경험 추론}하셨을 것 같아요. (2-3문장)"
    }
  },

  "lessons": {
    "title": "2025년이 가르쳐준 것들",
    "reading": "지난해를 통해 {이름}님이 배우신 것들이 있습니다. 첫째, {교훈 1}. 이 깨달음은 앞으로 {활용법 1}할 때 큰 도움이 될 거예요. 둘째, {교훈 2}. 이건 2026년 {활용법 2}에 적용하시면 좋겠습니다. 이런 소중한 경험들이 앞으로 {이름}님의 자산이 될 거예요. (5-6문장이 자연스럽게 이어지는 문단)",
    "keyLessons": ["핵심 교훈 1", "핵심 교훈 2", "핵심 교훈 3"]
  },

  "to2026": {
    "title": "2026년으로 가져가세요",
    "reading": "2025년 을사년의 유연함이 2026년 병오년의 열정과 만나면 멋진 시너지가 날 거예요. 지난해 {이름}님이 키우신 {강점}은 올해 화(火) 기운과 만나 더욱 빛날 수 있습니다. 다만 {주의점}은 올해 더 신경 쓰시면 좋겠어요. {구체적 조언}하시면서 2026년을 맞이하신다면, 지난해의 성장이 올해의 도약으로 이어질 거예요. (5-6문장이 자연스럽게 이어지는 문단)",
    "strengths": ["가져갈 강점 1", "가져갈 강점 2"],
    "watchOut": ["주의할 점 1"]
  },

  "closing": {
    "message": "2025년 한 해 고생 많으셨어요, {이름}님. 좋은 일도, 힘든 일도 모두 {이름}님을 성장시킨 소중한 경험이었습니다. 그 경험을 바탕으로 2026년에는 더 빛나시길 바랍니다. 새해에도 함께할게요! (3-4문장의 따뜻한 마무리)"
  }
}

[FINAL CHECK] 최종 확인
- "year": 반드시 2025 (2026 아님!)
- "months", "currentMonth", "current" 키 절대 사용 금지
- 이것은 2025년 회고 분석입니다. 월별 운세가 아닙니다!
''';
  }

  /// saju_base 내용을 포맷팅 (v3.0: Optional)
  /// - saju_base 없이도 운세 분석 가능 (saju_analyses만으로 충분)
  /// - saju_base가 있으면 참고 정보로 활용
  String _formatSajuBase() {
    final content = inputData.sajuBaseContent;

    // v3.0: sajuBaseContent가 null인 경우 (saju_analyses만 사용)
    if (content == null) {
      return '''
(saju_base 미사용 - v3.0)
※ 위의 사주 분석 데이터(saju_analyses)를 기반으로 운세를 분석합니다.
- 사주 팔자(천간/지지)
- 용신/희신/기신/구신
- 합충형파해
- 일간 강약
- 신살/십신
''';
    }

    final buffer = StringBuffer();

    if (content['personality'] != null) {
      buffer.writeln('### 성격/적성');
      buffer.writeln(content['personality'].toString());
    }

    if (content['wealth'] != null) {
      buffer.writeln('\n### 재물운');
      buffer.writeln(content['wealth'].toString());
    }

    if (content['career'] != null) {
      buffer.writeln('\n### 직업운');
      buffer.writeln(content['career'].toString());
    }

    if (content['health'] != null) {
      buffer.writeln('\n### 건강운');
      buffer.writeln(content['health'].toString());
    }

    if (content['love'] != null) {
      buffer.writeln('\n### 애정운');
      buffer.writeln(content['love'].toString());
    }

    return buffer.toString();
  }

  /// 2025년 巳(사)와 일지의 합충 관계 포맷팅
  String _format2025Hapchung() {
    final buffer = StringBuffer();
    final dayJi = inputData.dayJi;

    if (dayJi == null) {
      return '(합충 분석 정보 없음)';
    }

    buffer.writeln('- 사용자 일지: $dayJi');
    buffer.writeln('- 2025년 지지: 巳(사)');
    buffer.writeln();

    // 巳와의 합충 관계 분석
    final hapchungHint = _get2025HapchungHint(dayJi);
    if (hapchungHint.isNotEmpty) {
      buffer.writeln('** 합충 관계 분석:');
      buffer.writeln(hapchungHint);
    }

    return buffer.toString();
  }

  /// 일지와 2025년 巳의 합충 관계 힌트
  String _get2025HapchungHint(String dayJi) {
    final buffer = StringBuffer();
    // "진(辰)" → "辰" 한자 추출
    final dayJiHanja = _extractHanja(dayJi);

    // 巳와의 육충 (六衝)
    if (dayJiHanja == '亥') {
      buffer.writeln('- 巳亥衝(사해충) 발생!');
      buffer.writeln('  → 2025년에 삶의 큰 변화(이사/이직/관계 변화)가 있었을 가능성');
      buffer.writeln('  → 정체된 에너지가 움직이며 새로운 방향을 찾는 계기');
    }

    // 巳와의 육합 (六合)
    if (dayJiHanja == '申') {
      buffer.writeln('- 巳申合(사신합) 발생! → 합화수(合化水)');
      buffer.writeln('  → 2025년에 좋은 협력/파트너십/인연이 있었을 가능성');
      buffer.writeln('  → 새로운 만남이나 협업을 통한 발전');
    }

    // 巳와의 형 (刑)
    if (dayJiHanja == '寅') {
      buffer.writeln('- 巳寅刑(사인형) 발생! → 무례지형');
      buffer.writeln('  → 2025년에 관계에서 오해나 갈등이 있었을 가능성');
      buffer.writeln('  → 시련을 통한 성장의 기회, 인간관계 재정립');
    }

    // 巳와의 삼합 (三合) - 金局
    if (dayJiHanja == '酉' || dayJiHanja == '丑') {
      buffer.writeln('- 巳酉丑(사유축) 삼합 중 일부 구성');
      buffer.writeln('  → 2025년에 금(金) 기운 강화 가능성');
      buffer.writeln('  → ${dayJiHanja == '酉' ? '巳酉 반합' : '巳丑 부분합'}으로 일부 작용');
    }

    // 같은 지지
    if (dayJiHanja == '巳') {
      buffer.writeln('- 巳巳(사사) 자형(自刑) 가능성');
      buffer.writeln('  → 2025년에 자기 자신과의 싸움, 내면적 갈등');
      buffer.writeln('  → 자기 성찰과 성장의 해');
    }

    // 특별한 관계가 없는 경우
    if (buffer.isEmpty) {
      buffer.writeln('- $dayJi와 巳(사): 특별한 합충 관계 없음');
      buffer.writeln('  → 2025년이 상대적으로 평온했을 가능성');
      buffer.writeln('  → 다만 용신/기신과의 관계가 더 중요');
    }

    return buffer.toString();
  }

  /// "진(辰)" → "辰" 한자 추출 헬퍼
  String _extractHanja(String value) {
    // 이미 한자 1글자면 그대로 반환
    if (value.length == 1) return value;

    // "진(辰)" 형태에서 괄호 안 한자 추출
    final match = RegExp(r'\(([^)]+)\)').firstMatch(value);
    if (match != null) {
      return match.group(1) ?? value;
    }

    // 한글-한자 매핑
    const korToHanja = {
      '자': '子', '축': '丑', '인': '寅', '묘': '卯',
      '진': '辰', '사': '巳', '오': '午', '미': '未',
      '신': '申', '유': '酉', '술': '戌', '해': '亥',
    };

    // 한글만 있는 경우 매핑
    final lower = value.toLowerCase();
    for (final entry in korToHanja.entries) {
      if (lower.contains(entry.key)) {
        return entry.value;
      }
    }

    return value;
  }
}
